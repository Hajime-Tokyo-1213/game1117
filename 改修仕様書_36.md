# 改修仕様書 36

## フェーズ2.11 - 販売管理API実装

### 改修の目的
販売記録と売上管理をデータベースで管理するAPIを実装

### 改修内容

#### 1. 販売関連テーブル追加
```sql
-- scripts/migrations/sql/006_create_sales_tables.sql
CREATE TABLE sales (
    id SERIAL PRIMARY KEY,
    customer_name VARCHAR(255),
    customer_email VARCHAR(255),
    customer_phone VARCHAR(20),
    sale_date DATE NOT NULL DEFAULT CURRENT_DATE,
    total_amount DECIMAL(10,2) NOT NULL DEFAULT 0,
    payment_method VARCHAR(50),
    status VARCHAR(50) DEFAULT 'completed',
    notes TEXT,
    staff_id INTEGER REFERENCES users(id),
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

CREATE TABLE sale_items (
    id SERIAL PRIMARY KEY,
    sale_id INTEGER REFERENCES sales(id) ON DELETE CASCADE,
    product_id INTEGER REFERENCES products(id),
    product_name VARCHAR(255) NOT NULL,
    quantity INTEGER NOT NULL DEFAULT 1,
    unit_price DECIMAL(10,2) NOT NULL,
    total_price DECIMAL(10,2) NOT NULL,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

CREATE INDEX idx_sales_date ON sales(sale_date);
CREATE INDEX idx_sales_customer_email ON sales(customer_email);
CREATE INDEX idx_sales_staff_id ON sales(staff_id);
CREATE INDEX idx_sale_items_sale_id ON sale_items(sale_id);
CREATE INDEX idx_sale_items_product_id ON sale_items(product_id);
```

#### 2. 販売記録API実装
```javascript
// api/sales/index.js
import { authMiddleware } from '../utils/middleware.js';
import { query } from '../utils/database.js';

export default authMiddleware(async function handler(req, res) {
  switch (req.method) {
    case 'GET':
      return await getSales(req, res);
    case 'POST':
      return await createSale(req, res);
    default:
      return res.status(405).json({ error: 'Method not allowed' });
  }
});

async function getSales(req, res) {
  try {
    const { 
      customer_email,
      start_date,
      end_date,
      staff_id,
      page = 1, 
      limit = 50 
    } = req.query;
    
    let sql = `
      SELECT s.*, u.name as staff_name,
             COALESCE(
               JSON_AGG(
                 JSON_BUILD_OBJECT(
                   'id', si.id,
                   'product_name', si.product_name,
                   'quantity', si.quantity,
                   'unit_price', si.unit_price,
                   'total_price', si.total_price
                 ) ORDER BY si.id
               ) FILTER (WHERE si.id IS NOT NULL), 
               '[]'::json
             ) as items
      FROM sales s
      LEFT JOIN users u ON s.staff_id = u.id
      LEFT JOIN sale_items si ON s.id = si.sale_id
      WHERE 1=1
    `;
    
    const params = [];
    let paramCount = 0;
    
    if (customer_email) {
      paramCount++;
      sql += ` AND s.customer_email ILIKE $${paramCount}`;
      params.push(`%${customer_email}%`);
    }
    
    if (start_date) {
      paramCount++;
      sql += ` AND s.sale_date >= $${paramCount}`;
      params.push(start_date);
    }
    
    if (end_date) {
      paramCount++;
      sql += ` AND s.sale_date <= $${paramCount}`;
      params.push(end_date);
    }
    
    if (staff_id) {
      paramCount++;
      sql += ` AND s.staff_id = $${paramCount}`;
      params.push(staff_id);
    }
    
    sql += ` GROUP BY s.id, u.name`;
    sql += ` ORDER BY s.sale_date DESC, s.id DESC`;
    sql += ` LIMIT $${paramCount + 1} OFFSET $${paramCount + 2}`;
    params.push(limit, (page - 1) * limit);
    
    const { rows } = await query(sql, params);
    
    res.json({
      sales: rows,
      page: parseInt(page),
      limit: parseInt(limit)
    });
    
  } catch (error) {
    console.error('Get sales error:', error);
    res.status(500).json({ error: 'サーバーエラーが発生しました' });
  }
}

async function createSale(req, res) {
  try {
    // スタッフ以上のみ販売記録可能
    if (!['staff', 'admin'].includes(req.user.role)) {
      return res.status(403).json({ error: '権限がありません' });
    }
    
    const {
      customer_name,
      customer_email,
      customer_phone,
      payment_method,
      items,
      notes
    } = req.body;
    
    if (!items || !Array.isArray(items) || items.length === 0) {
      return res.status(400).json({ error: '販売商品が必要です' });
    }
    
    // 合計金額計算
    const total_amount = items.reduce((sum, item) => {
      return sum + (item.quantity * item.unit_price);
    }, 0);
    
    // トランザクション開始
    await query('BEGIN');
    
    try {
      // 販売記録作成
      const { rows: salesRows } = await query(`
        INSERT INTO sales (
          customer_name, customer_email, customer_phone,
          total_amount, payment_method, notes, staff_id
        ) VALUES ($1, $2, $3, $4, $5, $6, $7)
        RETURNING *
      `, [
        customer_name, customer_email, customer_phone,
        total_amount, payment_method, notes, req.user.userId
      ]);
      
      const sale = salesRows[0];
      
      // 販売商品詳細作成 & 在庫更新
      for (const item of items) {
        // 販売商品詳細追加
        await query(`
          INSERT INTO sale_items (
            sale_id, product_id, product_name, quantity, unit_price, total_price
          ) VALUES ($1, $2, $3, $4, $5, $6)
        `, [
          sale.id, item.product_id, item.product_name,
          item.quantity, item.unit_price, item.quantity * item.unit_price
        ]);
        
        // 在庫更新
        if (item.product_id) {
          await query(`
            UPDATE products 
            SET stock_quantity = stock_quantity - $1,
                updated_at = CURRENT_TIMESTAMP
            WHERE id = $2 AND stock_quantity >= $1
          `, [item.quantity, item.product_id]);
          
          // 在庫移動記録
          await query(`
            INSERT INTO stock_movements (
              product_id, movement_type, quantity, reference_id, reference_type, created_by
            ) VALUES ($1, 'out', $2, $3, 'sale', $4)
          `, [item.product_id, item.quantity, sale.id, req.user.userId]);
        }
      }
      
      await query('COMMIT');
      
      res.status(201).json({
        message: '販売記録を作成しました',
        sale: sale
      });
      
    } catch (error) {
      await query('ROLLBACK');
      throw error;
    }
    
  } catch (error) {
    console.error('Create sale error:', error);
    res.status(500).json({ error: 'サーバーエラーが発生しました' });
  }
}
```

#### 3. 売上統計API
```javascript
// api/sales/statistics.js
export default authMiddleware(async function handler(req, res) {
  try {
    const { start_date, end_date, group_by = 'day' } = req.query;
    
    let dateFormat;
    switch (group_by) {
      case 'month':
        dateFormat = 'YYYY-MM';
        break;
      case 'week':
        dateFormat = 'YYYY-"W"WW';
        break;
      default:
        dateFormat = 'YYYY-MM-DD';
    }
    
    let sql = `
      SELECT 
        TO_CHAR(sale_date, '${dateFormat}') as period,
        COUNT(*) as sale_count,
        SUM(total_amount) as total_revenue,
        AVG(total_amount) as avg_sale_amount
      FROM sales
      WHERE 1=1
    `;
    
    const params = [];
    let paramCount = 0;
    
    if (start_date) {
      paramCount++;
      sql += ` AND sale_date >= $${paramCount}`;
      params.push(start_date);
    }
    
    if (end_date) {
      paramCount++;
      sql += ` AND sale_date <= $${paramCount}`;
      params.push(end_date);
    }
    
    sql += ` GROUP BY period ORDER BY period DESC`;
    
    const { rows } = await query(sql, params);
    
    res.json({ statistics: rows });
    
  } catch (error) {
    console.error('Get sales statistics error:', error);
    res.status(500).json({ error: 'サーバーエラーが発生しました' });
  }
});
```

### 影響範囲
- 新規マイグレーション: `scripts/migrations/sql/006_create_sales_tables.sql`
- 新規: `api/sales/index.js`
- 新規: `api/sales/statistics.js`

### 所要時間
4-5時間

### 検証項目
- 販売記録の作成が正常動作すること
- 在庫連動が正確であること
- 売上統計が正しく計算されること

### 次のステップ
改修仕様書_37: 古物台帳API実装