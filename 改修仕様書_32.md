# 改修仕様書 32

## フェーズ2.7 - 認証API実装

### 改修の目的
データベースベースの認証APIを完全実装し、localStorageからの脱却を図る

### 改修内容

#### 1. 認証API基盤の拡張
```javascript
// api/auth/login.js
import { query } from '../utils/database.js';
import bcrypt from 'bcryptjs';
import jwt from 'jsonwebtoken';
import { authMiddleware } from '../utils/middleware.js';

export default async function handler(req, res) {
  if (req.method !== 'POST') {
    return res.status(405).json({ error: 'Method not allowed' });
  }

  try {
    const { email, password } = req.body;

    // ユーザー検索
    const { rows } = await query(
      'SELECT id, email, password_hash, role, name FROM users WHERE email = $1',
      [email]
    );

    if (rows.length === 0) {
      return res.status(401).json({ error: '認証に失敗しました' });
    }

    const user = rows[0];

    // パスワード検証
    const isValid = await bcrypt.compare(password, user.password_hash);
    if (!isValid) {
      return res.status(401).json({ error: '認証に失敗しました' });
    }

    // JWTトークン生成
    const token = jwt.sign(
      { 
        userId: user.id, 
        email: user.email, 
        role: user.role 
      },
      process.env.JWT_SECRET,
      { expiresIn: process.env.JWT_EXPIRES_IN || '7d' }
    );

    // セッション記録
    await query(
      'INSERT INTO user_sessions (user_id, token_hash, expires_at) VALUES ($1, $2, $3)',
      [user.id, token, new Date(Date.now() + 7 * 24 * 60 * 60 * 1000)]
    );

    // レスポンス
    res.status(200).json({
      token,
      user: {
        id: user.id,
        email: user.email,
        role: user.role,
        name: user.name
      }
    });

  } catch (error) {
    console.error('Login error:', error);
    res.status(500).json({ error: 'サーバーエラーが発生しました' });
  }
}
```

#### 2. ユーザー登録API
```javascript
// api/auth/register.js
export default async function handler(req, res) {
  if (req.method !== 'POST') {
    return res.status(405).json({ error: 'Method not allowed' });
  }

  try {
    const { email, password, name, role = 'customer' } = req.body;

    // バリデーション
    if (!email || !password || !name) {
      return res.status(400).json({ error: '必須項目が不足しています' });
    }

    // 重複チェック
    const { rows: existing } = await query(
      'SELECT id FROM users WHERE email = $1',
      [email]
    );

    if (existing.length > 0) {
      return res.status(409).json({ error: 'このメールアドレスは既に使用されています' });
    }

    // パスワードハッシュ化
    const passwordHash = await bcrypt.hash(password, 10);

    // ユーザー作成
    const { rows } = await query(
      `INSERT INTO users (email, password_hash, name, role) 
       VALUES ($1, $2, $3, $4) RETURNING id, email, name, role`,
      [email, passwordHash, name, role]
    );

    res.status(201).json({
      message: 'ユーザー登録が完了しました',
      user: rows[0]
    });

  } catch (error) {
    console.error('Registration error:', error);
    res.status(500).json({ error: 'サーバーエラーが発生しました' });
  }
}
```

#### 3. トークン検証・リフレッシュAPI
```javascript
// api/auth/verify.js
export default async function handler(req, res) {
  const token = req.headers.authorization?.replace('Bearer ', '');

  if (!token) {
    return res.status(401).json({ valid: false, error: 'トークンがありません' });
  }

  try {
    const decoded = jwt.verify(token, process.env.JWT_SECRET);

    // セッション確認
    const { rows } = await query(
      'SELECT id FROM user_sessions WHERE user_id = $1 AND token_hash = $2 AND expires_at > NOW()',
      [decoded.userId, token]
    );

    if (rows.length === 0) {
      return res.status(401).json({ valid: false, error: 'セッションが無効です' });
    }

    res.json({ valid: true, user: decoded });

  } catch (error) {
    res.status(401).json({ valid: false, error: 'トークンが無効です' });
  }
}
```

### 影響範囲
- `api/auth/login.js`の拡張
- 新規: `api/auth/register.js`
- `api/auth/verify.js`の拡張

### 所要時間
3-4時間

### 検証項目
- データベースベース認証が正常動作すること
- トークン管理が適切に行われること
- セッション管理が正確であること

### 次のステップ
改修仕様書_33: ユーザー管理API実装