# 改修仕様書 48

## フェーズ3.1 - TypeScript完全移行とプロジェクト設定の最適化

### 改修の目的
既存のJavaScriptプロジェクトを完全にTypeScriptへ移行し、型安全性を確保しながら開発生産性を大幅に向上させます。厳密な型チェックとモダンな開発環境を構築することで、バグの早期発見と保守性の向上を実現します。

### 改修内容

#### 1. TypeScript設定（tsconfig.json）
```json
{
  "compilerOptions": {
    // 言語とプラットフォーム設定
    "target": "ES2022",
    "lib": ["ES2022", "DOM", "DOM.Iterable", "WebWorker"],
    "module": "ESNext",
    "moduleResolution": "bundler",
    
    // 厳密な型チェック設定
    "strict": true,
    "noImplicitAny": true,
    "strictNullChecks": true,
    "strictFunctionTypes": true,
    "strictBindCallApply": true,
    "strictPropertyInitialization": true,
    "noImplicitThis": true,
    "useUnknownInCatchVariables": true,
    "alwaysStrict": true,
    
    // 追加の型チェックオプション
    "noUnusedLocals": true,
    "noUnusedParameters": true,
    "exactOptionalPropertyTypes": true,
    "noImplicitReturns": true,
    "noFallthroughCasesInSwitch": true,
    "noUncheckedIndexedAccess": true,
    "noImplicitOverride": true,
    "noPropertyAccessFromIndexSignature": true,
    
    // モジュール相互運用性
    "esModuleInterop": true,
    "allowSyntheticDefaultImports": true,
    "forceConsistentCasingInFileNames": true,
    "isolatedModules": true,
    
    // React設定
    "jsx": "react-jsx",
    "jsxImportSource": "react",
    
    // パス解決とインポート設定
    "baseUrl": ".",
    "paths": {
      "@/*": ["src/*"],
      "@components/*": ["src/components/*"],
      "@hooks/*": ["src/hooks/*"],
      "@utils/*": ["src/utils/*"],
      "@contexts/*": ["src/contexts/*"],
      "@pages/*": ["src/pages/*"],
      "@services/*": ["src/services/*"],
      "@types/*": ["src/types/*"],
      "@assets/*": ["src/assets/*"],
      "@constants": ["src/constants/index.ts"],
      "@config": ["src/config/index.ts"]
    },
    
    // 出力設定
    "outDir": "./dist",
    "removeComments": true,
    "sourceMap": true,
    "declaration": true,
    "declarationMap": true,
    "emitDecoratorMetadata": true,
    "experimentalDecorators": true,
    
    // その他の設定
    "skipLibCheck": true,
    "resolveJsonModule": true,
    "allowJs": false,
    "incremental": true,
    "tsBuildInfoFile": ".tsbuildinfo"
  },
  "include": [
    "src/**/*.ts",
    "src/**/*.tsx",
    "src/**/*.d.ts",
    "vite.config.ts"
  ],
  "exclude": [
    "node_modules",
    "dist",
    "build",
    "coverage",
    "**/*.spec.ts",
    "**/*.test.ts"
  ],
  "references": [
    { "path": "./tsconfig.node.json" }
  ]
}
```

#### 2. Vite設定の最適化（vite.config.ts）
```typescript
import { defineConfig, loadEnv } from 'vite';
import react from '@vitejs/plugin-react-swc';
import tsconfigPaths from 'vite-tsconfig-paths';
import { compression } from 'vite-plugin-compression2';
import { VitePWA } from 'vite-plugin-pwa';
import checker from 'vite-plugin-checker';
import { visualizer } from 'rollup-plugin-visualizer';
import legacy from '@vitejs/plugin-legacy';

export default defineConfig(({ mode }) => {
  const env = loadEnv(mode, process.cwd(), '');
  
  return {
    plugins: [
      react({
        jsxImportSource: 'react',
        plugins: [['@swc/plugin-styled-components', {}]]
      }),
      tsconfigPaths(),
      checker({
        typescript: true,
        eslint: {
          lintCommand: 'eslint "./src/**/*.{ts,tsx}"',
          useFlatConfig: true
        },
        overlay: {
          initialIsOpen: false,
          position: 'br'
        }
      }),
      compression({
        algorithm: 'gzip',
        exclude: [/\.(br)$/, /\.(gz)$/],
      }),
      compression({
        algorithm: 'brotliCompress',
        exclude: [/\.(br)$/, /\.(gz)$/],
      }),
      VitePWA({
        registerType: 'autoUpdate',
        includeAssets: ['favicon.ico', 'apple-touch-icon.png'],
        manifest: {
          name: 'Game Application',
          short_name: 'GameApp',
          theme_color: '#000000',
          background_color: '#ffffff',
          display: 'standalone'
        }
      }),
      legacy({
        targets: ['defaults', 'not IE 11']
      }),
      visualizer({
        filename: './dist/stats.html',
        open: false,
        gzipSize: true,
        brotliSize: true
      })
    ],
    resolve: {
      alias: {
        '@': '/src',
        '@components': '/src/components',
        '@hooks': '/src/hooks',
        '@utils': '/src/utils',
        '@contexts': '/src/contexts',
        '@pages': '/src/pages',
        '@services': '/src/services',
        '@types': '/src/types',
        '@assets': '/src/assets'
      }
    },
    build: {
      target: 'es2022',
      minify: 'terser',
      terserOptions: {
        compress: {
          drop_console: true,
          drop_debugger: true,
          pure_funcs: ['console.log', 'console.info']
        }
      },
      rollupOptions: {
        output: {
          manualChunks: {
            'react-vendor': ['react', 'react-dom', 'react-router-dom'],
            'ui-vendor': ['@mui/material', '@emotion/react', '@emotion/styled'],
            'utils': ['lodash-es', 'date-fns', 'axios']
          }
        }
      },
      chunkSizeWarningLimit: 1000,
      sourcemap: mode !== 'production',
      reportCompressedSize: false
    },
    optimizeDeps: {
      include: ['react', 'react-dom', 'react-router-dom'],
      exclude: ['@vite/client', '@vite/env']
    },
    server: {
      port: 3000,
      strictPort: true,
      open: true,
      cors: true,
      proxy: {
        '/api': {
          target: env.VITE_API_URL || 'http://localhost:8000',
          changeOrigin: true,
          secure: false
        }
      }
    },
    preview: {
      port: 4173,
      strictPort: true
    }
  };
});
```

#### 3. ESLint設定（eslint.config.js）
```javascript
import js from '@eslint/js';
import typescript from 'typescript-eslint';
import react from 'eslint-plugin-react';
import reactHooks from 'eslint-plugin-react-hooks';
import prettier from 'eslint-config-prettier';

export default [
  js.configs.recommended,
  ...typescript.configs.strictTypeChecked,
  {
    files: ['**/*.{ts,tsx}'],
    plugins: {
      '@typescript-eslint': typescript.plugin,
      'react': react,
      'react-hooks': reactHooks
    },
    languageOptions: {
      parser: typescript.parser,
      parserOptions: {
        ecmaVersion: 'latest',
        sourceType: 'module',
        project: './tsconfig.json',
        ecmaFeatures: {
          jsx: true
        }
      }
    },
    rules: {
      '@typescript-eslint/explicit-function-return-type': 'error',
      '@typescript-eslint/no-explicit-any': 'error',
      '@typescript-eslint/no-unused-vars': ['error', { 
        argsIgnorePattern: '^_',
        varsIgnorePattern: '^_'
      }],
      '@typescript-eslint/consistent-type-imports': ['error', {
        prefer: 'type-imports',
        fixStyle: 'inline-type-imports'
      }],
      '@typescript-eslint/naming-convention': [
        'error',
        {
          selector: 'interface',
          format: ['PascalCase'],
          prefix: ['I']
        },
        {
          selector: 'typeAlias',
          format: ['PascalCase']
        },
        {
          selector: 'enum',
          format: ['PascalCase']
        }
      ],
      'react/prop-types': 'off',
      'react/react-in-jsx-scope': 'off',
      'react-hooks/rules-of-hooks': 'error',
      'react-hooks/exhaustive-deps': 'warn'
    },
    settings: {
      react: {
        version: 'detect'
      }
    }
  },
  prettier
];
```

#### 4. Prettier設定（.prettierrc）
```json
{
  "semi": true,
  "trailingComma": "es5",
  "singleQuote": true,
  "printWidth": 100,
  "tabWidth": 2,
  "useTabs": false,
  "bracketSpacing": true,
  "arrowParens": "always",
  "endOfLine": "lf",
  "jsxSingleQuote": false,
  "jsxBracketSameLine": false,
  "importOrder": [
    "^react",
    "^@?\\w",
    "^@/",
    "^[./]"
  ],
  "importOrderSeparation": true,
  "importOrderSortSpecifiers": true
}
```

#### 5. package.jsonスクリプト更新
```json
{
  "scripts": {
    "dev": "vite",
    "build": "tsc && vite build",
    "preview": "vite preview",
    "type-check": "tsc --noEmit",
    "lint": "eslint . --ext .ts,.tsx --report-unused-disable-directives --max-warnings 0",
    "lint:fix": "eslint . --ext .ts,.tsx --fix",
    "format": "prettier --write \"src/**/*.{ts,tsx,json,css,md}\"",
    "format:check": "prettier --check \"src/**/*.{ts,tsx,json,css,md}\"",
    "validate": "npm run type-check && npm run lint && npm run format:check",
    "prepare": "husky install"
  }
}
```

### 影響範囲
- tsconfig.json（新規作成/更新）
- vite.config.ts（JavaScriptから移行）
- eslint.config.js（新規作成）
- .prettierrc（新規作成）
- package.json（スクリプト更新）
- 全ての.js/.jsxファイル（.ts/.tsxへ移行準備）
- CI/CDパイプライン設定

### 所要時間
4-6時間（設定とテストを含む）

### 検証項目
- [ ] TypeScriptコンパイラが全ファイルを正常に解析できること
- [ ] 厳密モードでのコンパイルエラーが0件であること
- [ ] ESLintが全ルールで正常に動作すること
- [ ] Prettierが自動フォーマットを実行できること
- [ ] Viteのビルドが正常に完了すること
- [ ] パスエイリアスが正しく解決されること
- [ ] ソースマップが正しく生成されること
- [ ] 開発サーバーが正常に起動すること
- [ ] ホットリロードが機能すること
- [ ] TypeScript Language Serverが正常に動作すること

### 次のステップ
改修仕様書_49: 基本型定義ファイルの作成と既存コードの段階的移行