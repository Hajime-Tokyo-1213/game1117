# 改修仕様書 34

## フェーズ2.9 - 在庫管理API実装

### 改修の目的
在庫管理機能をデータベースベースで提供するAPIを実装

### 改修内容

#### 1. 商品一覧・検索API
```javascript
// api/inventory/index.js
import { authMiddleware } from '../utils/middleware.js';
import { query } from '../utils/database.js';

export default authMiddleware(async function handler(req, res) {
  switch (req.method) {
    case 'GET':
      return await getInventory(req, res);
    case 'POST':
      return await addProduct(req, res);
    default:
      return res.status(405).json({ error: 'Method not allowed' });
  }
});

async function getInventory(req, res) {
  try {
    const { 
      search, 
      category, 
      manufacturer, 
      condition_grade,
      page = 1, 
      limit = 50,
      sortBy = 'created_at',
      sortOrder = 'DESC'
    } = req.query;
    
    let sql = `
      SELECT id, name, category, model, manufacturer, condition_grade,
             purchase_price, selling_price, stock_quantity, zaico_item_id,
             created_at, updated_at
      FROM products
      WHERE 1=1
    `;
    
    const params = [];
    let paramCount = 0;
    
    if (search) {
      paramCount++;
      sql += ` AND (name ILIKE $${paramCount} OR model ILIKE $${paramCount})`;
      params.push(`%${search}%`);
    }
    
    if (category) {
      paramCount++;
      sql += ` AND category = $${paramCount}`;
      params.push(category);
    }
    
    if (manufacturer) {
      paramCount++;
      sql += ` AND manufacturer = $${paramCount}`;
      params.push(manufacturer);
    }
    
    if (condition_grade) {
      paramCount++;
      sql += ` AND condition_grade = $${paramCount}`;
      params.push(condition_grade);
    }
    
    // ソート
    const validSortColumns = ['name', 'created_at', 'selling_price', 'stock_quantity'];
    const validSortOrders = ['ASC', 'DESC'];
    
    if (validSortColumns.includes(sortBy) && validSortOrders.includes(sortOrder.toUpperCase())) {
      sql += ` ORDER BY ${sortBy} ${sortOrder.toUpperCase()}`;
    } else {
      sql += ` ORDER BY created_at DESC`;
    }
    
    // ページネーション
    sql += ` LIMIT $${paramCount + 1} OFFSET $${paramCount + 2}`;
    params.push(limit, (page - 1) * limit);
    
    const { rows } = await query(sql, params);
    
    // 総数取得
    let countSql = 'SELECT COUNT(*) FROM products WHERE 1=1';
    const countParams = [];
    let countParamCount = 0;
    
    if (search) {
      countParamCount++;
      countSql += ` AND (name ILIKE $${countParamCount} OR model ILIKE $${countParamCount})`;
      countParams.push(`%${search}%`);
    }
    
    const { rows: countRows } = await query(countSql, countParams);
    
    res.json({
      products: rows,
      total: parseInt(countRows[0].count),
      page: parseInt(page),
      limit: parseInt(limit)
    });
    
  } catch (error) {
    console.error('Get inventory error:', error);
    res.status(500).json({ error: 'サーバーエラーが発生しました' });
  }
}

async function addProduct(req, res) {
  try {
    // 権限チェック（スタッフ以上）
    if (!['staff', 'admin'].includes(req.user.role)) {
      return res.status(403).json({ error: '権限がありません' });
    }
    
    const {
      name, category, model, manufacturer, condition_grade,
      purchase_price, selling_price, stock_quantity, zaico_item_id, zaico_data
    } = req.body;
    
    if (!name || !category) {
      return res.status(400).json({ error: '商品名とカテゴリは必須です' });
    }
    
    const { rows } = await query(`
      INSERT INTO products (
        name, category, model, manufacturer, condition_grade,
        purchase_price, selling_price, stock_quantity, zaico_item_id, zaico_data
      ) VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9, $10)
      RETURNING *
    `, [
      name, category, model, manufacturer, condition_grade,
      purchase_price || 0, selling_price || 0, stock_quantity || 0,
      zaico_item_id, zaico_data ? JSON.stringify(zaico_data) : null
    ]);
    
    res.status(201).json({ product: rows[0] });
    
  } catch (error) {
    console.error('Add product error:', error);
    res.status(500).json({ error: 'サーバーエラーが発生しました' });
  }
}
```

#### 2. 個別商品操作API
```javascript
// api/inventory/[id].js
export default authMiddleware(async function handler(req, res) {
  const { id } = req.query;
  
  switch (req.method) {
    case 'GET':
      return await getProduct(req, res, id);
    case 'PUT':
      return await updateProduct(req, res, id);
    case 'DELETE':
      return await deleteProduct(req, res, id);
    default:
      return res.status(405).json({ error: 'Method not allowed' });
  }
});
```

#### 3. 在庫移動記録API
```javascript
// api/inventory/movements.js
export default authMiddleware(async function handler(req, res) {
  switch (req.method) {
    case 'GET':
      return await getStockMovements(req, res);
    case 'POST':
      return await recordStockMovement(req, res);
    default:
      return res.status(405).json({ error: 'Method not allowed' });
  }
});
```

### 影響範囲
- 新規: `api/inventory/index.js`
- 新規: `api/inventory/[id].js`
- 新規: `api/inventory/movements.js`

### 所要時間
4-5時間

### 検証項目
- 在庫CRUD操作が正常動作すること
- 検索・フィルタ機能が正確であること
- 在庫移動記録が正しく管理されること

### 次のステップ
改修仕様書_35: 買取申請API実装