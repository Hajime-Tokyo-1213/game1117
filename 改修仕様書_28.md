# 改修仕様書 28

## フェーズ2.3 - データベーススキーマ設計

### 改修の目的
アプリケーションの全機能をサポートする包括的なデータベーススキーマを設計

### 改修内容

#### 1. ユーザー関連テーブル
```sql
-- users テーブル
CREATE TABLE users (
    id SERIAL PRIMARY KEY,
    email VARCHAR(255) UNIQUE NOT NULL,
    password_hash VARCHAR(255) NOT NULL,
    role VARCHAR(50) NOT NULL DEFAULT 'customer',
    name VARCHAR(255) NOT NULL,
    phone VARCHAR(20),
    address TEXT,
    postal_code VARCHAR(10),
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- user_sessions テーブル（JWT管理）
CREATE TABLE user_sessions (
    id SERIAL PRIMARY KEY,
    user_id INTEGER REFERENCES users(id) ON DELETE CASCADE,
    token_hash VARCHAR(255) NOT NULL,
    expires_at TIMESTAMP NOT NULL,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

#### 2. 在庫管理テーブル
```sql
-- products テーブル
CREATE TABLE products (
    id SERIAL PRIMARY KEY,
    name VARCHAR(255) NOT NULL,
    category VARCHAR(100),
    model VARCHAR(255),
    manufacturer VARCHAR(255),
    condition_grade VARCHAR(50),
    purchase_price DECIMAL(10,2),
    selling_price DECIMAL(10,2),
    stock_quantity INTEGER DEFAULT 0,
    zaico_item_id VARCHAR(255),
    zaico_data JSONB,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- stock_movements テーブル（在庫変動履歴）
CREATE TABLE stock_movements (
    id SERIAL PRIMARY KEY,
    product_id INTEGER REFERENCES products(id) ON DELETE CASCADE,
    movement_type VARCHAR(50) NOT NULL, -- 'in', 'out', 'adjustment'
    quantity INTEGER NOT NULL,
    reference_id INTEGER, -- 買取ID、販売IDなど
    reference_type VARCHAR(50), -- 'buyback', 'sale', 'adjustment'
    notes TEXT,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    created_by INTEGER REFERENCES users(id)
);
```

#### 3. 古物台帳テーブル設計
```sql
-- antiquities_ledger テーブル
CREATE TABLE antiquities_ledger (
    id SERIAL PRIMARY KEY,
    transaction_date DATE NOT NULL,
    transaction_type VARCHAR(50) NOT NULL, -- 'purchase', 'sale'
    item_name VARCHAR(255) NOT NULL,
    item_description TEXT,
    quantity INTEGER DEFAULT 1,
    unit_price DECIMAL(10,2),
    total_amount DECIMAL(10,2),
    counterpart_name VARCHAR(255) NOT NULL,
    counterpart_address TEXT,
    counterpart_phone VARCHAR(20),
    counterpart_id_type VARCHAR(50),
    counterpart_id_number VARCHAR(100),
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

### 影響範囲
- 新規: データベーススキーマファイル
- ドキュメント: データモデル仕様書

### 所要時間
4-6時間

### 検証項目
- 全機能要件がスキーマでサポートされること
- 法的要件（古物営業法）が満たされること
- データ整合性制約が適切に設定されること

### 次のステップ
改修仕様書_29: マイグレーションスクリプト作成