# 改修仕様書

## 改修の目的
コードベースの品質向上、セキュリティ強化、保守性の改善、本番環境対応

---

## 改修フェーズ概要

### フェーズ1: セキュリティ緊急対応（最優先）
### フェーズ2: データ永続化基盤構築
### フェーズ3: コード品質改善
### フェーズ4: テスト・ドキュメント整備
### フェーズ5: パフォーマンス最適化

---

## フェーズ1: セキュリティ緊急対応

### 1.1 APIキー管理の改善

#### 現状の問題
- APIキーがlocalStorageに保存され、フロントエンドから直接アクセス可能
- ブラウザの開発者ツールで簡単に取得可能

#### 改修内容
1. **バックエンドAPIルートの強化**
   - 環境変数によるAPIキー管理
   - APIキーの暗号化保存
   - APIキーのローテーション機能

2. **フロントエンドからのAPIキー削除**
   - `zaicoApi.js`の修正
   - `zaicoClient.js`への完全移行
   - localStorageからのAPIキー削除

#### 影響範囲
- `src/utils/zaicoApi.js`
- `src/utils/zaicoClient.js`
- `src/components/ApiKeyChecker.jsx`
- `src/pages/ZaicoSyncSettings.jsx`
- `api/zaico/[...path].js`

#### 作業工数
- バックエンドAPIルート強化: 2-3時間
- フロントエンド修正: 2-3時間
- テスト: 1-2時間
- **合計: 5-8時間**

---

### 1.2 パスワード管理の改善

#### 現状の問題
- パスワードが平文でlocalStorageに保存
- ハッシュ化されていない

#### 改修内容
1. **パスワードハッシュ化の実装**
   - bcryptまたは同等のライブラリを使用
   - パスワードのハッシュ化・検証機能

2. **既存パスワードの移行**
   - 既存ユーザーのパスワードをハッシュ化
   - 次回ログイン時に自動移行

#### 影響範囲
- `src/contexts/AuthContext.jsx`
- `src/components/Login.jsx`
- `src/components/Register.jsx`
- `src/components/StaffLogin.jsx`
- `src/components/CustomerLogin.jsx`
- `src/components/BuyerLogin.jsx`

#### 作業工数
- ハッシュ化ライブラリの導入: 1時間
- 認証ロジックの修正: 3-4時間
- 既存データの移行: 2-3時間
- テスト: 2時間
- **合計: 8-10時間**

---

### 1.3 認証トークンの導入

#### 現状の問題
- JWT等の認証トークンを使用していない
- セッション管理が不十分

#### 改修内容
1. **JWT認証の実装**
   - アクセストークン・リフレッシュトークンの発行
   - トークンの検証機能
   - トークンの有効期限管理

2. **セッション管理の改善**
   - トークンの安全な保存（httpOnly cookie推奨）
   - 自動ログアウト機能

#### 影響範囲
- バックエンドAPI（新規作成）
- `src/contexts/AuthContext.jsx`
- 全認証関連コンポーネント
- `src/components/PrivateRoute.jsx`

#### 作業工数
- バックエンドJWT実装: 4-6時間
- フロントエンド統合: 3-4時間
- テスト: 2-3時間
- **合計: 9-13時間**

---

### 1.4 入力値検証の統一

#### 現状の問題
- 検証ロジックが各コンポーネントに分散
- XSS対策が不十分

#### 改修内容
1. **共通バリデーションライブラリの作成**
   - `src/utils/validation.js`の作成
   - メール、電話番号、郵便番号等の検証関数
   - XSS対策（サニタイゼーション）

2. **既存コンポーネントの修正**
   - 各コンポーネントで共通ライブラリを使用
   - 重複コードの削除

#### 影響範囲
- 新規: `src/utils/validation.js`
- `src/components/Register.jsx`
- `src/pages/AccountSettings.jsx`
- `src/pages/StaffManagement.jsx`
- その他フォームコンポーネント

#### 作業工数
- 共通ライブラリ作成: 2-3時間
- 既存コンポーネント修正: 4-6時間
- テスト: 2時間
- **合計: 8-11時間**

---

## フェーズ2: データ永続化基盤構築

### 2.1 バックエンドAPIの構築

#### 現状の問題
- 実質的なバックエンドが存在しない
- データがlocalStorageのみに保存

#### 改修内容
1. **バックエンドフレームワークの選定・導入**
   - Node.js + Express または Next.js API Routes
   - データベース（PostgreSQL推奨）の導入

2. **APIエンドポイントの実装**
   - 認証API
   - 在庫管理API
   - 買取申請API
   - 販売管理API
   - 古物台帳API
   - ダッシュボードAPI

#### 影響範囲
- バックエンド（新規構築）
- 全フロントエンドコンポーネント（API呼び出しの変更）

#### 作業工数
- バックエンド基盤構築: 8-12時間
- APIエンドポイント実装: 20-30時間
- フロントエンド統合: 15-20時間
- テスト: 10-15時間
- **合計: 53-77時間**

---

### 2.2 データベース設計・実装

#### 改修内容
1. **データベーススキーマ設計**
   - ユーザーテーブル
   - 在庫テーブル
   - 買取申請テーブル
   - 販売記録テーブル
   - 古物台帳テーブル
   - 価格マスタテーブル

2. **マイグレーションスクリプト**
   - スキーマ定義
   - 初期データ投入

3. **既存データの移行**
   - localStorageからデータベースへの移行ツール
   - データ整合性チェック

#### 影響範囲
- データベース（新規構築）
- マイグレーションスクリプト
- データ移行ツール

#### 作業工数
- データベース設計: 4-6時間
- スキーマ実装: 6-8時間
- マイグレーション: 4-6時間
- データ移行ツール: 6-8時間
- テスト: 4-6時間
- **合計: 24-34時間**

---

### 2.3 データアクセス層の実装

#### 改修内容
1. **データアクセス層の作成**
   - ORM（Prisma/Sequelize等）の導入
   - リポジトリパターンの実装
   - トランザクション管理

2. **フロントエンドAPIクライアントの作成**
   - `src/utils/apiClient.js`の作成
   - localStorage操作の削除
   - API呼び出しの統一

#### 影響範囲
- バックエンド（データアクセス層）
- `src/utils/apiClient.js`（新規）
- 全コンポーネント（localStorage操作の削除）

#### 作業工数
- データアクセス層: 8-12時間
- APIクライアント: 4-6時間
- 既存コード修正: 15-20時間
- テスト: 6-8時間
- **合計: 33-46時間**

---

## フェーズ3: コード品質改善

### 3.1 TypeScript導入

#### 改修内容
1. **TypeScript設定**
   - `tsconfig.json`の作成
   - Vite設定の更新

2. **段階的な移行**
   - 新規ファイルはTypeScriptで作成
   - 既存ファイルを段階的に移行
   - 型定義ファイルの作成

#### 影響範囲
- プロジェクト設定
- 全ソースファイル（段階的移行）

#### 作業工数
- TypeScript設定: 2-3時間
- 型定義作成: 10-15時間
- 既存ファイル移行: 30-40時間
- テスト: 8-10時間
- **合計: 50-68時間**

---

### 3.2 コードの重複解消

#### 改修内容
1. **共通ユーティリティの抽出**
   - localStorage操作の共通化
   - 日付処理の共通化
   - フォーマット処理の共通化

2. **カスタムフックの作成**
   - `useLocalStorage`フック
   - `useApi`フック
   - `useAuth`フック（既存の拡張）

#### 影響範囲
- `src/utils/`（共通ユーティリティ）
- `src/hooks/`（新規、カスタムフック）
- 全コンポーネント（共通化の適用）

#### 作業工数
- 共通ユーティリティ作成: 6-8時間
- カスタムフック作成: 4-6時間
- 既存コード修正: 12-16時間
- テスト: 4-6時間
- **合計: 26-36時間**

---

### 3.3 エラーハンドリングの統一

#### 改修内容
1. **エラーハンドリングユーティリティの作成**
   - エラークラスの定義
   - エラーログの統一
   - ユーザー向けエラーメッセージの管理

2. **既存コードの修正**
   - try-catchの統一
   - エラーメッセージの統一

#### 影響範囲
- `src/utils/errorHandler.js`（新規）
- 全コンポーネント（エラーハンドリングの修正）

#### 作業工数
- エラーハンドリングユーティリティ: 4-6時間
- 既存コード修正: 10-15時間
- テスト: 4-6時間
- **合計: 18-27時間**

---

### 3.4 デバッグコードの削除

#### 改修内容
1. **ログレベルの導入**
   - 開発環境と本番環境でログレベルを分離
   - ログライブラリの導入（例: winston）

2. **console.logの削除・置換**
   - 本番環境用のログシステムに置換
   - デバッグ用console.logの削除

#### 影響範囲
- 全ソースファイル（349箇所のconsole.log）

#### 作業工数
- ログシステム導入: 2-3時間
- console.logの置換: 8-12時間
- テスト: 2-3時間
- **合計: 12-18時間**

---

### 3.5 非推奨コードの削除

#### 改修内容
1. **非推奨コンポーネントの削除**
   - `BuyerLogin.jsx`の削除
   - `BuyerRegister.jsx`の削除
   - 関連ルートの削除

2. **未使用コードの削除**
   - 未使用のimport文
   - 未使用の関数・変数

#### 影響範囲
- `src/components/BuyerLogin.jsx`
- `src/components/BuyerRegister.jsx`
- `src/App.jsx`（ルート定義）

#### 作業工数
- 非推奨コード削除: 2-3時間
- 未使用コード削除: 4-6時間
- テスト: 2時間
- **合計: 8-11時間**

---

## フェーズ4: テスト・ドキュメント整備

### 4.1 テストフレームワークの導入

#### 改修内容
1. **テスト環境の構築**
   - Jest + React Testing Libraryの導入
   - テスト設定ファイルの作成

2. **テストの実装**
   - 単体テスト（ユーティリティ関数）
   - コンポーネントテスト
   - 統合テスト（API連携）

#### 影響範囲
- テスト設定ファイル
- テストファイル（新規作成）

#### 作業工数
- テスト環境構築: 4-6時間
- 単体テスト実装: 20-30時間
- コンポーネントテスト: 30-40時間
- 統合テスト: 15-20時間
- **合計: 69-96時間**

---

### 4.2 ドキュメント整備

#### 改修内容
1. **技術ドキュメント**
   - API仕様書
   - データモデル定義
   - コンポーネント仕様
   - アーキテクチャ図

2. **開発者向けドキュメント**
   - 開発環境構築手順
   - デプロイ手順
   - コーディング規約

#### 影響範囲
- ドキュメントファイル（新規作成）

#### 作業工数
- API仕様書: 8-12時間
- データモデル定義: 4-6時間
- コンポーネント仕様: 10-15時間
- 開発者向けドキュメント: 6-8時間
- **合計: 28-41時間**

---

## フェーズ5: パフォーマンス最適化

### 5.1 React最適化

#### 改修内容
1. **メモ化の実装**
   - `React.memo`の適用
   - `useMemo`、`useCallback`の適切な使用

2. **コード分割**
   - ルートベースのコード分割
   - 動的インポートの実装

#### 影響範囲
- 全Reactコンポーネント

#### 作業工数
- メモ化実装: 8-12時間
- コード分割: 4-6時間
- テスト: 4-6時間
- **合計: 16-24時間**

---

### 5.2 データ取得の最適化

#### 改修内容
1. **ページネーションの実装**
   - 大量データの分割取得
   - 仮想スクロールの導入

2. **キャッシュ戦略**
   - React Query等の導入
   - データキャッシュの実装

#### 影響範囲
- データ取得コンポーネント
- APIエンドポイント

#### 作業工数
- ページネーション実装: 6-8時間
- キャッシュ戦略: 8-12時間
- テスト: 4-6時間
- **合計: 18-26時間**

---

### 5.3 バンドルサイズの最適化

#### 改修内容
1. **バンドル分析**
   - バンドルサイズの分析
   - 不要な依存関係の削除

2. **最適化**
   - Tree shakingの確認
   - 動的インポートの最適化

#### 影響範囲
- ビルド設定
- 依存関係

#### 作業工数
- バンドル分析: 2-3時間
- 最適化: 4-6時間
- テスト: 2-3時間
- **合計: 8-12時間**

---

## 改修作業の分割案

### 推奨分割数: 80-100回

各フェーズを細かく分割し、1回の作業セッションで完了できる単位に分割することを推奨します。

#### 分割の考え方
- **1回の作業セッション**: 2-4時間で完了できる作業単位
- **依存関係を考慮**: 前の作業が完了してから次の作業に進む
- **テスト可能な単位**: 各作業は独立してテスト可能

#### 具体的な分割例

**フェーズ1: セキュリティ緊急対応（15-20回）**
- 1.1 APIキー管理: 5-8回
- 1.2 パスワード管理: 6-8回
- 1.3 認証トークン: 4-6回
- 1.4 入力値検証: 4-6回

**フェーズ2: データ永続化基盤構築（30-40回）**
- 2.1 バックエンドAPI: 15-20回
- 2.2 データベース: 8-12回
- 2.3 データアクセス層: 7-8回

**フェーズ3: コード品質改善（25-35回）**
- 3.1 TypeScript導入: 15-20回
- 3.2 コード重複解消: 6-8回
- 3.3 エラーハンドリング: 4-6回
- 3.4 デバッグコード削除: 3-4回
- 3.5 非推奨コード削除: 2-3回

**フェーズ4: テスト・ドキュメント（25-35回）**
- 4.1 テストフレームワーク: 18-25回
- 4.2 ドキュメント整備: 7-10回

**フェーズ5: パフォーマンス最適化（10-15回）**
- 5.1 React最適化: 4-6回
- 5.2 データ取得最適化: 4-6回
- 5.3 バンドル最適化: 2-3回

**合計: 105-145回**

ただし、実際の作業では重複や調整が必要なため、**80-100回程度**が現実的な目安です。

---

## 改修の優先順位

### 最優先（即座に実施）
1. フェーズ1: セキュリティ緊急対応

### 高優先度（フェーズ1完了後）
2. フェーズ2: データ永続化基盤構築

### 中優先度（フェーズ2完了後）
3. フェーズ3: コード品質改善
4. フェーズ4: テスト・ドキュメント整備

### 低優先度（継続的改善）
5. フェーズ5: パフォーマンス最適化

---

## 改修スケジュール案

### 短期（1-2ヶ月）
- フェーズ1: セキュリティ緊急対応

### 中期（3-6ヶ月）
- フェーズ2: データ永続化基盤構築
- フェーズ3: コード品質改善（一部）

### 長期（6-12ヶ月）
- フェーズ3: コード品質改善（完了）
- フェーズ4: テスト・ドキュメント整備
- フェーズ5: パフォーマンス最適化

---

## 注意事項

1. **段階的な実装**: 一度に全てを変更せず、段階的に進める
2. **テストの重要性**: 各フェーズで十分なテストを実施
3. **バックアップ**: 改修前に必ずバックアップを取得
4. **ロールバック計画**: 問題発生時のロールバック計画を準備
5. **ドキュメント更新**: 改修に合わせてドキュメントを更新

