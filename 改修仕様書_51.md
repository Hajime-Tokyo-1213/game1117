# 改修仕様書 51

## フェーズ4 - Supabase RLS（Row Level Security）完全実装

### 改修の目的
Supabaseの行レベルセキュリティ（RLS）を完全実装し、データアクセス制御をデータベースレベルで実現します。これにより、APIレベルのセキュリティチェックを削減し、パフォーマンスとセキュリティを向上させます。

### 改修内容

#### 1. RLSポリシーの実装
```sql
-- Enable RLS on all tables
ALTER TABLE profiles ENABLE ROW LEVEL SECURITY;
ALTER TABLE products ENABLE ROW LEVEL SECURITY;
ALTER TABLE transactions ENABLE ROW LEVEL SECURITY;
ALTER TABLE inventory ENABLE ROW LEVEL SECURITY;

-- Profiles policies
CREATE POLICY "Users can view own profile" 
  ON profiles FOR SELECT 
  USING (auth.uid() = id);

CREATE POLICY "Users can update own profile" 
  ON profiles FOR UPDATE 
  USING (auth.uid() = id);

-- Products policies (staff and admin only)
CREATE POLICY "Staff can manage products" 
  ON products FOR ALL 
  USING (
    EXISTS (
      SELECT 1 FROM profiles 
      WHERE id = auth.uid() 
      AND role IN ('staff', 'admin', 'super_admin')
    )
  );

CREATE POLICY "Customers can view active products" 
  ON products FOR SELECT 
  USING (status = 'active');

-- Transactions policies
CREATE POLICY "Users can view own transactions" 
  ON transactions FOR SELECT 
  USING (user_id = auth.uid());

CREATE POLICY "Staff can view all transactions" 
  ON transactions FOR SELECT 
  USING (
    EXISTS (
      SELECT 1 FROM profiles 
      WHERE id = auth.uid() 
      AND role IN ('staff', 'admin', 'super_admin')
    )
  );

CREATE POLICY "Staff can create transactions" 
  ON transactions FOR INSERT 
  WITH CHECK (
    EXISTS (
      SELECT 1 FROM profiles 
      WHERE id = auth.uid() 
      AND role IN ('staff', 'admin', 'super_admin')
    )
  );
```

#### 2. TypeScript型定義とヘルパー関数
```typescript
// lib/supabase/policies.ts
import { SupabaseClient } from '@supabase/supabase-js';

export type UserRole = 'customer' | 'staff' | 'admin' | 'super_admin';

export interface RLSContext {
  userId: string;
  role: UserRole;
  permissions: string[];
}

export class SupabaseRLS {
  constructor(private supabase: SupabaseClient) {}

  async getCurrentUserContext(): Promise<RLSContext | null> {
    const { data: { user } } = await this.supabase.auth.getUser();
    
    if (!user) return null;
    
    const { data: profile } = await this.supabase
      .from('profiles')
      .select('role, permissions')
      .eq('id', user.id)
      .single();
    
    return {
      userId: user.id,
      role: profile?.role || 'customer',
      permissions: profile?.permissions || []
    };
  }

  // RLSバイパス用のサービスロールクライアント作成
  createAdminClient(): SupabaseClient {
    if (!process.env.SUPABASE_SERVICE_ROLE_KEY) {
      throw new Error('Service role key not configured');
    }
    
    return createClient(
      process.env.NEXT_PUBLIC_SUPABASE_URL!,
      process.env.SUPABASE_SERVICE_ROLE_KEY,
      {
        auth: {
          autoRefreshToken: false,
          persistSession: false
        }
      }
    );
  }
}
```

#### 3. フロントエンドでのRLS対応
```typescript
// hooks/useSupabaseRLS.ts
import { useEffect, useState } from 'react';
import { useSupabaseClient, useUser } from '@supabase/auth-helpers-react';

export function useSupabaseRLS() {
  const supabase = useSupabaseClient();
  const user = useUser();
  const [userRole, setUserRole] = useState<UserRole>('customer');
  
  useEffect(() => {
    if (user) {
      fetchUserRole();
    }
  }, [user]);
  
  const fetchUserRole = async () => {
    const { data } = await supabase
      .from('profiles')
      .select('role')
      .eq('id', user?.id)
      .single();
    
    if (data) {
      setUserRole(data.role);
    }
  };
  
  const canAccess = (resource: string, action: string): boolean => {
    const permissions = {
      customer: {
        products: ['view'],
        transactions: ['view_own'],
        profile: ['view_own', 'edit_own']
      },
      staff: {
        products: ['view', 'create', 'edit'],
        transactions: ['view_all', 'create'],
        profile: ['view_own', 'edit_own'],
        reports: ['view']
      },
      admin: {
        products: ['view', 'create', 'edit', 'delete'],
        transactions: ['view_all', 'create', 'edit'],
        profile: ['view_all', 'edit_all'],
        reports: ['view', 'export'],
        users: ['view', 'edit']
      },
      super_admin: {
        '*': ['*'] // Full access
      }
    };
    
    if (userRole === 'super_admin') return true;
    
    return permissions[userRole]?.[resource]?.includes(action) || false;
  };
  
  return {
    user,
    userRole,
    canAccess,
    isStaff: ['staff', 'admin', 'super_admin'].includes(userRole),
    isAdmin: ['admin', 'super_admin'].includes(userRole)
  };
}
```

#### 4. テスト用RLSバリデーション
```typescript
// __tests__/rls-policies.test.ts
describe('RLS Policies', () => {
  it('customer should only see own transactions', async () => {
    const { data, error } = await customerClient
      .from('transactions')
      .select('*');
    
    expect(error).toBeNull();
    data?.forEach(transaction => {
      expect(transaction.user_id).toBe(customerId);
    });
  });
  
  it('staff should see all transactions', async () => {
    const { data, error } = await staffClient
      .from('transactions')
      .select('*');
    
    expect(error).toBeNull();
    expect(data?.length).toBeGreaterThan(0);
  });
  
  it('customer cannot modify products', async () => {
    const { error } = await customerClient
      .from('products')
      .update({ name: 'Hacked' })
      .eq('id', productId);
    
    expect(error).not.toBeNull();
    expect(error.code).toBe('42501'); // Insufficient privilege
  });
});
```

### 影響範囲
- すべてのデータベーステーブル
- Supabaseクライアントを使用するすべてのコンポーネント
- 認証・認可ロジック
- APIエンドポイント（多くが不要になる）

### 所要時間
6-8時間

### 検証項目
- [ ] 各ロールで適切なデータのみアクセス可能
- [ ] 不正なアクセス試行が拒否される
- [ ] パフォーマンスが劣化していない
- [ ] 管理者機能が正常動作
- [ ] RLSバイパスが必要な処理の特定と対応

### 次のステップ
改修仕様書_52: Supabaseリアルタイム機能実装