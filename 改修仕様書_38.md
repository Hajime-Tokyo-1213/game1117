# 改修仕様書 38

## フェーズ2.13 - ダッシュボードAPI実装

### 改修の目的
ダッシュボード表示用の統計データと集計情報を提供するAPIを実装

### 改修内容

#### 1. ダッシュボード統計API
```javascript
// api/dashboard/statistics.js
import { authMiddleware } from '../utils/middleware.js';
import { query } from '../utils/database.js';

export default authMiddleware(async function handler(req, res) {
  if (req.method !== 'GET') {
    return res.status(405).json({ error: 'Method not allowed' });
  }

  try {
    const { period = '30days' } = req.query;
    
    // 期間設定
    let dateFilter = '';
    let dateParams = [];
    
    switch (period) {
      case '7days':
        dateFilter = "AND created_at >= CURRENT_DATE - INTERVAL '7 days'";
        break;
      case '30days':
        dateFilter = "AND created_at >= CURRENT_DATE - INTERVAL '30 days'";
        break;
      case '90days':
        dateFilter = "AND created_at >= CURRENT_DATE - INTERVAL '90 days'";
        break;
      case '1year':
        dateFilter = "AND created_at >= CURRENT_DATE - INTERVAL '1 year'";
        break;
    }

    // 基本統計データを並列取得
    const [
      totalProducts,
      lowStockProducts,
      pendingBuybacks,
      recentSales,
      totalRevenue,
      inventoryValue
    ] = await Promise.all([
      // 総在庫数
      query('SELECT COUNT(*) as count, SUM(stock_quantity) as total_stock FROM products'),
      
      // 低在庫商品
      query('SELECT COUNT(*) as count FROM products WHERE stock_quantity <= 5'),
      
      // 未処理買取申請
      query("SELECT COUNT(*) as count FROM buyback_requests WHERE status = 'pending'"),
      
      // 最近の売上
      query(`
        SELECT COUNT(*) as count, COALESCE(SUM(total_amount), 0) as revenue
        FROM sales 
        WHERE 1=1 ${dateFilter}
      `),
      
      // 総売上
      query('SELECT COALESCE(SUM(total_amount), 0) as total FROM sales'),
      
      // 在庫評価額
      query(`
        SELECT COALESCE(SUM(selling_price * stock_quantity), 0) as value 
        FROM products 
        WHERE stock_quantity > 0
      `)
    ]);

    // レスポンス組み立て
    res.json({
      overview: {
        total_products: parseInt(totalProducts.rows[0].count),
        total_stock: parseInt(totalProducts.rows[0].total_stock || 0),
        low_stock_products: parseInt(lowStockProducts.rows[0].count),
        pending_buybacks: parseInt(pendingBuybacks.rows[0].count),
        inventory_value: parseFloat(inventoryValue.rows[0].value || 0)
      },
      
      sales: {
        recent_count: parseInt(recentSales.rows[0].count),
        recent_revenue: parseFloat(recentSales.rows[0].revenue || 0),
        total_revenue: parseFloat(totalRevenue.rows[0].total || 0)
      },
      
      period: period
    });

  } catch (error) {
    console.error('Get dashboard statistics error:', error);
    res.status(500).json({ error: 'サーバーエラーが発生しました' });
  }
});
```

#### 2. 売上推移API
```javascript
// api/dashboard/revenue-trend.js
export default authMiddleware(async function handler(req, res) {
  if (req.method !== 'GET') {
    return res.status(405).json({ error: 'Method not allowed' });
  }

  try {
    const { period = '30days', group_by = 'day' } = req.query;
    
    let dateFormat, intervalClause;
    switch (group_by) {
      case 'month':
        dateFormat = 'YYYY-MM';
        intervalClause = period === '1year' ? "INTERVAL '12 months'" : "INTERVAL '6 months'";
        break;
      case 'week':
        dateFormat = 'YYYY-"W"WW';
        intervalClause = "INTERVAL '12 weeks'";
        break;
      default:
        dateFormat = 'YYYY-MM-DD';
        intervalClause = "INTERVAL '30 days'";
    }
    
    const { rows } = await query(`
      SELECT 
        TO_CHAR(sale_date, '${dateFormat}') as period,
        COUNT(*) as sales_count,
        COALESCE(SUM(total_amount), 0) as revenue,
        COALESCE(AVG(total_amount), 0) as avg_sale_amount
      FROM sales
      WHERE sale_date >= CURRENT_DATE - ${intervalClause}
      GROUP BY period
      ORDER BY period ASC
    `);

    res.json({
      trend: rows,
      group_by: group_by,
      period: period
    });

  } catch (error) {
    console.error('Get revenue trend error:', error);
    res.status(500).json({ error: 'サーバーエラーが発生しました' });
  }
});
```

#### 3. カテゴリ別分析API
```javascript
// api/dashboard/category-analysis.js
export default authMiddleware(async function handler(req, res) {
  if (req.method !== 'GET') {
    return res.status(405).json({ error: 'Method not allowed' });
  }

  try {
    // カテゴリ別在庫分析
    const inventoryAnalysis = await query(`
      SELECT 
        category,
        COUNT(*) as product_count,
        SUM(stock_quantity) as total_stock,
        COALESCE(SUM(selling_price * stock_quantity), 0) as inventory_value,
        COALESCE(AVG(selling_price), 0) as avg_price
      FROM products
      WHERE stock_quantity > 0
      GROUP BY category
      ORDER BY inventory_value DESC
    `);

    // カテゴリ別売上分析（過去30日）
    const salesAnalysis = await query(`
      SELECT 
        p.category,
        COUNT(si.*) as items_sold,
        COALESCE(SUM(si.total_price), 0) as revenue,
        COALESCE(AVG(si.unit_price), 0) as avg_selling_price
      FROM sale_items si
      JOIN products p ON si.product_id = p.id
      JOIN sales s ON si.sale_id = s.id
      WHERE s.sale_date >= CURRENT_DATE - INTERVAL '30 days'
      GROUP BY p.category
      ORDER BY revenue DESC
    `);

    // カテゴリ別買取申請分析
    const buybackAnalysis = await query(`
      SELECT 
        JSON_EXTRACT_PATH_TEXT(items_description, 'category') as category,
        COUNT(*) as request_count,
        COALESCE(AVG(estimated_value), 0) as avg_estimated_value
      FROM buyback_requests
      WHERE created_at >= CURRENT_DATE - INTERVAL '30 days'
        AND JSON_EXTRACT_PATH_TEXT(items_description, 'category') IS NOT NULL
      GROUP BY category
      ORDER BY request_count DESC
    `);

    res.json({
      inventory: inventoryAnalysis.rows,
      sales: salesAnalysis.rows,
      buyback_requests: buybackAnalysis.rows
    });

  } catch (error) {
    console.error('Get category analysis error:', error);
    res.status(500).json({ error: 'サーバーエラーが発生しました' });
  }
});
```

#### 4. アクティビティフィードAPI
```javascript
// api/dashboard/activities.js
export default authMiddleware(async function handler(req, res) {
  if (req.method !== 'GET') {
    return res.status(405).json({ error: 'Method not allowed' });
  }

  try {
    const { limit = 20 } = req.query;

    const activities = await query(`
      (
        SELECT 
          'sale' as type,
          'sales' as table_name,
          id as record_id,
          customer_name as description,
          total_amount as amount,
          created_at
        FROM sales
      )
      UNION ALL
      (
        SELECT 
          'buyback' as type,
          'buyback_requests' as table_name,
          id as record_id,
          customer_name as description,
          estimated_value as amount,
          created_at
        FROM buyback_requests
      )
      UNION ALL
      (
        SELECT 
          'product' as type,
          'products' as table_name,
          id as record_id,
          name as description,
          selling_price as amount,
          created_at
        FROM products
      )
      ORDER BY created_at DESC
      LIMIT $1
    `, [limit]);

    res.json({
      activities: activities.rows
    });

  } catch (error) {
    console.error('Get activities error:', error);
    res.status(500).json({ error: 'サーバーエラーが発生しました' });
  }
});
```

### 影響範囲
- 新規: `api/dashboard/statistics.js`
- 新規: `api/dashboard/revenue-trend.js`
- 新規: `api/dashboard/category-analysis.js`
- 新規: `api/dashboard/activities.js`

### 所要時間
4-5時間

### 検証項目
- 統計データが正確に計算されること
- パフォーマンスが許容範囲内であること
- リアルタイム性が確保されていること

### 次のステップ
改修仕様書_39: API共通エラーハンドリング実装