# 改修仕様書 31

## フェーズ2.6 - localStorageデータ移行ツール作成

### 改修の目的
既存のlocalStorageデータを新しいデータベースに安全に移行するツールを作成

### 改修内容

#### 1. データ移行ツールの作成
```javascript
// scripts/migrateLocalStorageData.js
import { query } from '../api/utils/database.js';
import bcrypt from 'bcryptjs';

class LocalStorageDataMigrator {
  constructor(localStorageSnapshot) {
    this.snapshot = localStorageSnapshot;
  }

  async migrateUsers() {
    const users = this.snapshot.users || [];
    
    for (const user of users) {
      // パスワードハッシュ化（平文の場合）
      const passwordHash = user.password.startsWith('$2a$') 
        ? user.password 
        : await bcrypt.hash(user.password, 10);

      await query(`
        INSERT INTO users (email, password_hash, role, name, phone, address, postal_code)
        VALUES ($1, $2, $3, $4, $5, $6, $7)
        ON CONFLICT (email) DO UPDATE SET
          password_hash = EXCLUDED.password_hash,
          role = EXCLUDED.role,
          name = EXCLUDED.name,
          phone = EXCLUDED.phone,
          address = EXCLUDED.address,
          postal_code = EXCLUDED.postal_code,
          updated_at = CURRENT_TIMESTAMP
      `, [
        user.email,
        passwordHash,
        user.role || 'customer',
        user.name,
        user.phone,
        user.address,
        user.postalCode
      ]);
    }
  }

  async migrateInventory() {
    const inventoryItems = this.snapshot.inventory || [];
    
    for (const item of inventoryItems) {
      await query(`
        INSERT INTO products (
          name, category, model, manufacturer, condition_grade,
          purchase_price, selling_price, stock_quantity, zaico_item_id, zaico_data
        ) VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9, $10)
      `, [
        item.name,
        item.category,
        item.model,
        item.manufacturer,
        item.condition || 'B',
        item.purchasePrice || 0,
        item.sellingPrice || 0,
        item.quantity || 0,
        item.zaicoId,
        JSON.stringify(item.zaicoData || {})
      ]);
    }
  }

  async migrateBuybackRequests() {
    const buybackData = this.snapshot.buybackRequests || [];
    
    for (const request of buybackData) {
      await query(`
        INSERT INTO buyback_requests (
          customer_name, email, phone, address, postal_code,
          items_description, estimated_value, status, created_at
        ) VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9)
      `, [
        request.customerName,
        request.email,
        request.phone,
        request.address,
        request.postalCode,
        JSON.stringify(request.items || []),
        request.estimatedValue || 0,
        request.status || 'pending',
        request.createdAt || new Date()
      ]);
    }
  }

  async run() {
    console.log('Starting localStorage data migration...');
    
    try {
      await this.migrateUsers();
      console.log('Users migration completed');
      
      await this.migrateInventory();
      console.log('Inventory migration completed');
      
      await this.migrateBuybackRequests();
      console.log('Buyback requests migration completed');
      
      console.log('Migration completed successfully');
    } catch (error) {
      console.error('Migration failed:', error);
      throw error;
    }
  }
}
```

#### 2. データ抽出ヘルパー
```javascript
// src/utils/dataExtractor.js
export const extractLocalStorageData = () => {
  const data = {};
  
  // 既存のlocalStorageキーを全て抽出
  const keys = [
    'users', 'currentUser', 'inventory', 'buybackRequests',
    'salesData', 'antiquitiesLedger', 'priceData'
  ];
  
  keys.forEach(key => {
    const item = localStorage.getItem(key);
    if (item) {
      try {
        data[key] = JSON.parse(item);
      } catch (e) {
        data[key] = item;
      }
    }
  });
  
  return data;
};
```

### 影響範囲
- 新規: `scripts/migrateLocalStorageData.js`
- 新規: `src/utils/dataExtractor.js`

### 所要時間
4-6時間

### 検証項目
- 全データタイプが正確に移行されること
- データ整合性が保持されること
- エラー時のロールバック機能

### 次のステップ
改修仕様書_32: 認証API実装