# 改修仕様書 35

## フェーズ2.10 - 買取申請API実装

### 改修の目的
買取申請プロセスをデータベースベースで管理するAPIを実装

### 改修内容

#### 1. 買取申請テーブル追加
```sql
-- scripts/migrations/sql/005_create_buyback_requests.sql
CREATE TABLE buyback_requests (
    id SERIAL PRIMARY KEY,
    customer_name VARCHAR(255) NOT NULL,
    email VARCHAR(255) NOT NULL,
    phone VARCHAR(20),
    address TEXT,
    postal_code VARCHAR(10),
    items_description JSONB NOT NULL,
    estimated_value DECIMAL(10,2) DEFAULT 0,
    status VARCHAR(50) DEFAULT 'pending',
    notes TEXT,
    staff_id INTEGER REFERENCES users(id),
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

CREATE INDEX idx_buyback_requests_email ON buyback_requests(email);
CREATE INDEX idx_buyback_requests_status ON buyback_requests(status);
CREATE INDEX idx_buyback_requests_created_at ON buyback_requests(created_at);
```

#### 2. 買取申請API実装
```javascript
// api/buyback/index.js
import { authMiddleware } from '../utils/middleware.js';
import { query } from '../utils/database.js';
import { validateAndSanitize } from '../../src/utils/validation.js';

export default async function handler(req, res) {
  switch (req.method) {
    case 'GET':
      return await authMiddleware(getBuybackRequests)(req, res);
    case 'POST':
      return await createBuybackRequest(req, res);
    default:
      return res.status(405).json({ error: 'Method not allowed' });
  }
}

async function getBuybackRequests(req, res) {
  try {
    // スタッフ以上のみアクセス可能
    if (!['staff', 'admin'].includes(req.user.role)) {
      return res.status(403).json({ error: '権限がありません' });
    }
    
    const { 
      status, 
      email, 
      page = 1, 
      limit = 50,
      sortBy = 'created_at',
      sortOrder = 'DESC'
    } = req.query;
    
    let sql = `
      SELECT br.*, u.name as staff_name
      FROM buyback_requests br
      LEFT JOIN users u ON br.staff_id = u.id
      WHERE 1=1
    `;
    
    const params = [];
    let paramCount = 0;
    
    if (status) {
      paramCount++;
      sql += ` AND br.status = $${paramCount}`;
      params.push(status);
    }
    
    if (email) {
      paramCount++;
      sql += ` AND br.email ILIKE $${paramCount}`;
      params.push(`%${email}%`);
    }
    
    sql += ` ORDER BY br.${sortBy} ${sortOrder.toUpperCase()}`;
    sql += ` LIMIT $${paramCount + 1} OFFSET $${paramCount + 2}`;
    params.push(limit, (page - 1) * limit);
    
    const { rows } = await query(sql, params);
    
    res.json({
      requests: rows,
      total: rows.length,
      page: parseInt(page),
      limit: parseInt(limit)
    });
    
  } catch (error) {
    console.error('Get buyback requests error:', error);
    res.status(500).json({ error: 'サーバーエラーが発生しました' });
  }
}

async function createBuybackRequest(req, res) {
  try {
    const {
      customer_name,
      email,
      phone,
      address,
      postal_code,
      items_description
    } = req.body;
    
    // バリデーション
    const validations = {
      customer_name: validateAndSanitize(customer_name, 'required'),
      email: validateAndSanitize(email, 'email'),
      phone: validateAndSanitize(phone, 'phone')
    };
    
    const hasErrors = Object.values(validations).some(v => !v.isValid);
    if (hasErrors) {
      const errors = Object.fromEntries(
        Object.entries(validations)
          .filter(([_, v]) => v.error)
          .map(([k, v]) => [k, v.error])
      );
      return res.status(400).json({ error: 'バリデーションエラー', details: errors });
    }
    
    if (!items_description || !Array.isArray(items_description) || items_description.length === 0) {
      return res.status(400).json({ error: '買取希望商品の情報が必要です' });
    }
    
    // 買取申請作成
    const { rows } = await query(`
      INSERT INTO buyback_requests (
        customer_name, email, phone, address, postal_code, items_description
      ) VALUES ($1, $2, $3, $4, $5, $6)
      RETURNING *
    `, [
      validations.customer_name.value,
      validations.email.value,
      validations.phone.value,
      address,
      postal_code,
      JSON.stringify(items_description)
    ]);
    
    res.status(201).json({
      message: '買取申請を受け付けました',
      request: rows[0]
    });
    
  } catch (error) {
    console.error('Create buyback request error:', error);
    res.status(500).json({ error: 'サーバーエラーが発生しました' });
  }
}
```

#### 3. 買取申請ステータス更新API
```javascript
// api/buyback/[id].js
export default authMiddleware(async function handler(req, res) {
  const { id } = req.query;
  
  switch (req.method) {
    case 'GET':
      return await getBuybackRequest(req, res, id);
    case 'PUT':
      return await updateBuybackRequest(req, res, id);
    default:
      return res.status(405).json({ error: 'Method not allowed' });
  }
});

async function updateBuybackRequest(req, res, id) {
  try {
    // スタッフ以上のみ更新可能
    if (!['staff', 'admin'].includes(req.user.role)) {
      return res.status(403).json({ error: '権限がありません' });
    }
    
    const { status, estimated_value, notes } = req.body;
    
    const validStatuses = ['pending', 'reviewing', 'approved', 'rejected', 'completed'];
    if (status && !validStatuses.includes(status)) {
      return res.status(400).json({ error: '無効なステータスです' });
    }
    
    const { rows } = await query(`
      UPDATE buyback_requests 
      SET status = $2, estimated_value = $3, notes = $4, 
          staff_id = $5, updated_at = CURRENT_TIMESTAMP
      WHERE id = $1 
      RETURNING *
    `, [id, status, estimated_value, notes, req.user.userId]);
    
    if (rows.length === 0) {
      return res.status(404).json({ error: '買取申請が見つかりません' });
    }
    
    res.json({
      message: '買取申請を更新しました',
      request: rows[0]
    });
    
  } catch (error) {
    console.error('Update buyback request error:', error);
    res.status(500).json({ error: 'サーバーエラーが発生しました' });
  }
}
```

### 影響範囲
- 新規マイグレーション: `scripts/migrations/sql/005_create_buyback_requests.sql`
- 新規: `api/buyback/index.js`
- 新規: `api/buyback/[id].js`

### 所要時間
3-4時間

### 検証項目
- 買取申請の作成が正常動作すること
- ステータス管理が適切であること
- バリデーションが正確に機能すること

### 次のステップ
改修仕様書_36: 販売管理API実装