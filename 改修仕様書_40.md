# 改修仕様書 40

## フェーズ2.15 - フロントエンドAPIクライアント作成

### 改修の目的
フロントエンドから新しいバックエンドAPIを使用するための統一されたクライアントライブラリを作成

### 改修内容

#### 1. ベースAPIクライアントの作成
```javascript
// src/utils/apiClient.js
class ApiClient {
  constructor() {
    this.baseUrl = process.env.NODE_ENV === 'production' 
      ? 'https://your-domain.com' 
      : 'http://localhost:3000';
    this.token = null;
  }

  setAuthToken(token) {
    this.token = token;
  }

  async request(endpoint, options = {}) {
    const url = `${this.baseUrl}/api${endpoint}`;
    
    const defaultOptions = {
      headers: {
        'Content-Type': 'application/json',
        ...(this.token && { Authorization: `Bearer ${this.token}` })
      }
    };

    const finalOptions = {
      ...defaultOptions,
      ...options,
      headers: {
        ...defaultOptions.headers,
        ...(options.headers || {})
      }
    };

    try {
      const response = await fetch(url, finalOptions);
      
      if (!response.ok) {
        const errorData = await response.json();
        throw new ApiError(
          errorData.message || 'APIエラーが発生しました',
          response.status,
          errorData.code,
          errorData.details
        );
      }

      const data = await response.json();
      return data;

    } catch (error) {
      if (error instanceof ApiError) {
        throw error;
      }

      // ネットワークエラーなど
      throw new ApiError(
        'ネットワークエラーが発生しました',
        0,
        'NETWORK_ERROR'
      );
    }
  }

  // HTTP メソッド用のヘルパー
  async get(endpoint, params = {}) {
    const queryString = new URLSearchParams(params).toString();
    const url = queryString ? `${endpoint}?${queryString}` : endpoint;
    return this.request(url, { method: 'GET' });
  }

  async post(endpoint, body = {}) {
    return this.request(endpoint, {
      method: 'POST',
      body: JSON.stringify(body)
    });
  }

  async put(endpoint, body = {}) {
    return this.request(endpoint, {
      method: 'PUT',
      body: JSON.stringify(body)
    });
  }

  async delete(endpoint) {
    return this.request(endpoint, { method: 'DELETE' });
  }
}

class ApiError extends Error {
  constructor(message, status, code, details) {
    super(message);
    this.status = status;
    this.code = code;
    this.details = details;
    this.name = 'ApiError';
  }
}

export const apiClient = new ApiClient();
export { ApiError };
```

#### 2. 認証専用クライアント
```javascript
// src/utils/authClient.js
import { apiClient } from './apiClient.js';

export const authClient = {
  async login(email, password) {
    const response = await apiClient.post('/auth/login', {
      email,
      password
    });
    
    if (response.token) {
      apiClient.setAuthToken(response.token);
    }
    
    return response;
  },

  async register(userData) {
    return apiClient.post('/auth/register', userData);
  },

  async logout() {
    try {
      await apiClient.post('/auth/logout');
    } finally {
      // トークンを削除（API呼び出しが失敗してもクライアント側は削除）
      apiClient.setAuthToken(null);
    }
  },

  async verifyToken() {
    return apiClient.get('/auth/verify');
  },

  async refreshToken() {
    const response = await apiClient.post('/auth/refresh');
    
    if (response.token) {
      apiClient.setAuthToken(response.token);
    }
    
    return response;
  },

  async getProfile() {
    return apiClient.get('/users/profile');
  },

  async updateProfile(profileData) {
    return apiClient.put('/users/profile', profileData);
  }
};
```

#### 3. 在庫管理専用クライアント
```javascript
// src/utils/inventoryClient.js
import { apiClient } from './apiClient.js';

export const inventoryClient = {
  async getInventory(params = {}) {
    return apiClient.get('/inventory', params);
  },

  async getProduct(id) {
    return apiClient.get(`/inventory/${id}`);
  },

  async addProduct(productData) {
    return apiClient.post('/inventory', productData);
  },

  async updateProduct(id, productData) {
    return apiClient.put(`/inventory/${id}`, productData);
  },

  async deleteProduct(id) {
    return apiClient.delete(`/inventory/${id}`);
  },

  async getStockMovements(params = {}) {
    return apiClient.get('/inventory/movements', params);
  },

  async recordStockMovement(movementData) {
    return apiClient.post('/inventory/movements', movementData);
  },

  async searchProducts(searchTerm, filters = {}) {
    return this.getInventory({
      search: searchTerm,
      ...filters
    });
  },

  async getProductsByCategory(category, params = {}) {
    return this.getInventory({
      category,
      ...params
    });
  },

  async getLowStockProducts(threshold = 5) {
    // この機能はAPIで実装する必要がある
    return apiClient.get('/inventory/low-stock', { threshold });
  }
};
```

#### 4. 買取申請専用クライアント
```javascript
// src/utils/buybackClient.js
import { apiClient } from './apiClient.js';

export const buybackClient = {
  async getBuybackRequests(params = {}) {
    return apiClient.get('/buyback', params);
  },

  async getBuybackRequest(id) {
    return apiClient.get(`/buyback/${id}`);
  },

  async createBuybackRequest(requestData) {
    return apiClient.post('/buyback', requestData);
  },

  async updateBuybackRequest(id, updateData) {
    return apiClient.put(`/buyback/${id}`, updateData);
  },

  async approveBuybackRequest(id, estimatedValue, notes = '') {
    return this.updateBuybackRequest(id, {
      status: 'approved',
      estimated_value: estimatedValue,
      notes
    });
  },

  async rejectBuybackRequest(id, reason = '') {
    return this.updateBuybackRequest(id, {
      status: 'rejected',
      notes: reason
    });
  },

  async completeBuybackRequest(id) {
    return this.updateBuybackRequest(id, {
      status: 'completed'
    });
  },

  async getBuybacksByEmail(email) {
    return this.getBuybackRequests({ email });
  },

  async getBuybacksByStatus(status) {
    return this.getBuybackRequests({ status });
  }
};
```

#### 5. 統合クライアントエクスポート
```javascript
// src/utils/api.js
export { apiClient, ApiError } from './apiClient.js';
export { authClient } from './authClient.js';
export { inventoryClient } from './inventoryClient.js';
export { buybackClient } from './buybackClient.js';

// 売上管理クライアント
export const salesClient = {
  async getSales(params = {}) {
    return apiClient.get('/sales', params);
  },

  async createSale(saleData) {
    return apiClient.post('/sales', saleData);
  },

  async getSalesStatistics(params = {}) {
    return apiClient.get('/sales/statistics', params);
  }
};

// 古物台帳クライアント
export const antiquitiesClient = {
  async getRecords(params = {}) {
    return apiClient.get('/antiquities', params);
  },

  async createRecord(recordData) {
    return apiClient.post('/antiquities', recordData);
  },

  async exportRecords(params = {}) {
    return apiClient.get('/antiquities/export', params);
  }
};

// ダッシュボードクライアント
export const dashboardClient = {
  async getStatistics(period = '30days') {
    return apiClient.get('/dashboard/statistics', { period });
  },

  async getRevenueTrend(params = {}) {
    return apiClient.get('/dashboard/revenue-trend', params);
  },

  async getCategoryAnalysis() {
    return apiClient.get('/dashboard/category-analysis');
  },

  async getActivities(limit = 20) {
    return apiClient.get('/dashboard/activities', { limit });
  }
};

// ユーザー管理クライアント
export const usersClient = {
  async getUsers(params = {}) {
    return apiClient.get('/users', params);
  },

  async getUser(id) {
    return apiClient.get(`/users/${id}`);
  },

  async updateUser(id, userData) {
    return apiClient.put(`/users/${id}`, userData);
  },

  async deleteUser(id) {
    return apiClient.delete(`/users/${id}`);
  }
};
```

### 影響範囲
- 新規: `src/utils/apiClient.js`
- 新規: `src/utils/authClient.js`
- 新規: `src/utils/inventoryClient.js`
- 新規: `src/utils/buybackClient.js`
- 新規: `src/utils/api.js`

### 所要時間
4-5時間

### 検証項目
- 全APIエンドポイントにアクセス可能であること
- エラーハンドリングが適切であること
- 認証トークン管理が正常動作すること

### 次のステップ
改修仕様書_41: AuthContextのAPIクライアント統合