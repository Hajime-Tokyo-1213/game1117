# 改修仕様書 27

## フェーズ2.2 - データベース選定と接続設定

### 改修の目的
適切なデータベースを選定し、接続設定を構築する

### 改修内容

#### 1. データベースの選定
PostgreSQL を採用
- 理由: ACID準拠の堅牢性
- JSON型サポート（Zaico連携データ格納）
- スケーラビリティ
- クラウド対応（Vercel Postgres等）

#### 2. データベース接続ライブラリの導入
```json
{
  "dependencies": {
    "pg": "^8.8.0",
    "@types/pg": "^8.6.0",
    "dotenv": "^16.0.0"
  }
}
```

#### 3. データベース接続設定
```javascript
// api/utils/database.js
import { Pool } from 'pg';

const pool = new Pool({
  connectionString: process.env.DATABASE_URL,
  ssl: process.env.NODE_ENV === 'production' ? { rejectUnauthorized: false } : false
});

export const query = async (text, params) => {
  const start = Date.now();
  const res = await pool.query(text, params);
  const duration = Date.now() - start;
  
  console.log('Executed query', { text, duration, rows: res.rowCount });
  return res;
};

export default pool;
```

#### 4. 環境設定の拡張
```env
# Database
DATABASE_URL=postgresql://username:password@localhost:5432/game_f_db

# Development
DEV_DATABASE_URL=postgresql://username:password@localhost:5432/game_f_dev

# Test
TEST_DATABASE_URL=postgresql://username:password@localhost:5432/game_f_test
```

### 影響範囲
- `package.json`
- 新規: `api/utils/database.js`
- `.env.example`

### 所要時間
2-3時間

### 検証項目
- データベース接続が正常に確立されること
- 接続プールが適切に動作すること
- 環境別の設定が正しく読み込まれること

### 次のステップ
改修仕様書_28: データベーススキーマ設計