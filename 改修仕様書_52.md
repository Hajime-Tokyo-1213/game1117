# 改修仕様書 52

## フェーズ4 - Supabaseリアルタイム機能実装

### 改修の目的
Supabase Realtimeを活用し、在庫更新、価格変更、新規取引をリアルタイムで反映するシステムを構築します。WebSocketベースの双方向通信により、ユーザー体験を大幅に向上させます。

### 改修内容

#### 1. リアルタイム購読設定
```typescript
// lib/supabase/realtime.ts
import { RealtimeChannel, RealtimePostgresChangesPayload } from '@supabase/supabase-js';
import { supabase } from './client';

export class RealtimeManager {
  private channels: Map<string, RealtimeChannel> = new Map();

  // 在庫変更のリアルタイム監視
  subscribeToInventory(
    onUpdate: (payload: RealtimePostgresChangesPayload<any>) => void
  ): RealtimeChannel {
    const channel = supabase
      .channel('inventory-changes')
      .on(
        'postgres_changes',
        {
          event: '*',
          schema: 'public',
          table: 'inventory',
        },
        (payload) => {
          console.log('Inventory change:', payload);
          onUpdate(payload);
        }
      )
      .subscribe();
    
    this.channels.set('inventory', channel);
    return channel;
  }

  // 商品価格変更の監視
  subscribeToPriceChanges(
    onPriceChange: (payload: RealtimePostgresChangesPayload<any>) => void
  ): RealtimeChannel {
    const channel = supabase
      .channel('price-updates')
      .on(
        'postgres_changes',
        {
          event: 'UPDATE',
          schema: 'public',
          table: 'products',
          filter: 'selling_price=gte.0',
        },
        (payload) => {
          if (payload.new.selling_price !== payload.old.selling_price) {
            onPriceChange(payload);
          }
        }
      )
      .subscribe();
    
    this.channels.set('prices', channel);
    return channel;
  }

  // 新規取引の監視（スタッフ向け）
  subscribeToTransactions(
    onNewTransaction: (payload: RealtimePostgresChangesPayload<any>) => void
  ): RealtimeChannel {
    const channel = supabase
      .channel('transaction-feed')
      .on(
        'postgres_changes',
        {
          event: 'INSERT',
          schema: 'public',
          table: 'transactions',
        },
        onNewTransaction
      )
      .subscribe();
    
    this.channels.set('transactions', channel);
    return channel;
  }

  // プレゼンス機能（オンラインユーザー表示）
  subscribeToPresence(roomId: string) {
    const channel = supabase.channel(`room:${roomId}`);
    
    channel
      .on('presence', { event: 'sync' }, () => {
        const state = channel.presenceState();
        console.log('Online users:', state);
      })
      .on('presence', { event: 'join' }, ({ key, newPresences }) => {
        console.log('User joined:', key, newPresences);
      })
      .on('presence', { event: 'leave' }, ({ key, leftPresences }) => {
        console.log('User left:', key, leftPresences);
      })
      .subscribe(async (status) => {
        if (status === 'SUBSCRIBED') {
          const { data: { user } } = await supabase.auth.getUser();
          await channel.track({
            user_id: user?.id,
            online_at: new Date().toISOString(),
          });
        }
      });
    
    return channel;
  }

  // チャンネルのクリーンアップ
  unsubscribe(channelName: string) {
    const channel = this.channels.get(channelName);
    if (channel) {
      supabase.removeChannel(channel);
      this.channels.delete(channelName);
    }
  }

  unsubscribeAll() {
    this.channels.forEach((channel) => {
      supabase.removeChannel(channel);
    });
    this.channels.clear();
  }
}
```

#### 2. Reactフックでのリアルタイム実装
```typescript
// hooks/useRealtimeInventory.ts
import { useEffect, useState } from 'react';
import { RealtimeManager } from '@/lib/supabase/realtime';

export function useRealtimeInventory(productId?: string) {
  const [inventory, setInventory] = useState<any[]>([]);
  const [lastUpdate, setLastUpdate] = useState<Date | null>(null);
  const realtimeManager = new RealtimeManager();

  useEffect(() => {
    // 初期データ取得
    fetchInventory();

    // リアルタイム購読開始
    const channel = realtimeManager.subscribeToInventory((payload) => {
      switch (payload.eventType) {
        case 'INSERT':
          setInventory(prev => [...prev, payload.new]);
          break;
        case 'UPDATE':
          setInventory(prev => 
            prev.map(item => 
              item.id === payload.new.id ? payload.new : item
            )
          );
          break;
        case 'DELETE':
          setInventory(prev => 
            prev.filter(item => item.id !== payload.old.id)
          );
          break;
      }
      setLastUpdate(new Date());
      
      // トースト通知
      showNotification({
        type: 'info',
        message: `在庫が更新されました: ${payload.new?.product_name || 'アイテム'}`,
      });
    });

    return () => {
      realtimeManager.unsubscribe('inventory');
    };
  }, [productId]);

  const fetchInventory = async () => {
    const query = supabase.from('inventory').select('*');
    
    if (productId) {
      query.eq('product_id', productId);
    }
    
    const { data, error } = await query;
    if (data) setInventory(data);
  };

  return { inventory, lastUpdate };
}
```

#### 3. リアルタイムダッシュボード
```tsx
// components/RealtimeDashboard.tsx
import { useRealtimeInventory } from '@/hooks/useRealtimeInventory';
import { useRealtimeTransactions } from '@/hooks/useRealtimeTransactions';
import { Card, Badge, AnimatePresence, motion } from '@/components/ui';

export function RealtimeDashboard() {
  const { inventory } = useRealtimeInventory();
  const { transactions, onlineUsers } = useRealtimeTransactions();

  return (
    <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
      {/* オンラインユーザー表示 */}
      <Card>
        <h3>オンラインスタッフ</h3>
        <div className="flex gap-2">
          {onlineUsers.map(user => (
            <Badge key={user.id} variant="success">
              {user.name}
            </Badge>
          ))}
        </div>
      </Card>

      {/* リアルタイム在庫 */}
      <Card>
        <h3>在庫アラート</h3>
        <AnimatePresence>
          {inventory
            .filter(item => item.quantity < item.min_stock)
            .map(item => (
              <motion.div
                key={item.id}
                initial={{ opacity: 0, y: -20 }}
                animate={{ opacity: 1, y: 0 }}
                exit={{ opacity: 0, y: 20 }}
                className="alert alert-warning"
              >
                {item.product_name}: 残り{item.quantity}個
              </motion.div>
            ))}
        </AnimatePresence>
      </Card>

      {/* 最新取引 */}
      <Card>
        <h3>最新の取引</h3>
        <div className="space-y-2">
          {transactions.slice(0, 5).map(tx => (
            <div key={tx.id} className="flex justify-between">
              <span>{tx.transaction_number}</span>
              <Badge>¥{tx.total_amount.toLocaleString()}</Badge>
            </div>
          ))}
        </div>
      </Card>
    </div>
  );
}
```

#### 4. ブロードキャスト機能（カスタムイベント）
```typescript
// lib/supabase/broadcast.ts
export class BroadcastManager {
  private channel: RealtimeChannel;

  constructor(roomName: string) {
    this.channel = supabase.channel(roomName);
  }

  // 価格変更通知を全ユーザーに送信
  async broadcastPriceChange(productId: string, newPrice: number) {
    await this.channel.send({
      type: 'broadcast',
      event: 'price-change',
      payload: {
        productId,
        newPrice,
        timestamp: new Date().toISOString(),
      },
    });
  }

  // 在庫切れアラート
  async broadcastOutOfStock(product: any) {
    await this.channel.send({
      type: 'broadcast',
      event: 'out-of-stock',
      payload: {
        product,
        message: `${product.name}が在庫切れになりました`,
      },
    });
  }

  // イベントリスナー登録
  onPriceChange(callback: (payload: any) => void) {
    this.channel.on('broadcast', { event: 'price-change' }, callback);
  }

  onOutOfStock(callback: (payload: any) => void) {
    this.channel.on('broadcast', { event: 'out-of-stock' }, callback);
  }

  subscribe() {
    return this.channel.subscribe();
  }

  unsubscribe() {
    supabase.removeChannel(this.channel);
  }
}
```

### 影響範囲
- インベントリ管理画面
- 商品一覧・詳細画面
- ダッシュボード
- 取引管理画面
- 通知システム

### 所要時間
8-10時間

### 検証項目
- [ ] データ変更が即座に反映される
- [ ] 複数ユーザー間で同期が取れる
- [ ] WebSocket接続が安定している
- [ ] 再接続処理が正常動作
- [ ] パフォーマンスへの影響が許容範囲内
- [ ] オフライン時の動作確認

### 次のステップ
改修仕様書_53: Supabase Edge Functions実装