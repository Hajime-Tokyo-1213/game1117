# 改修仕様書 53

## フェーズ4 - Supabase Edge Functions実装

### 改修の目的
複雑なビジネスロジックをSupabase Edge Functionsに移行し、サーバーレスアーキテクチャを実現します。Deno環境で動作する軽量で高速なFunctionsを活用し、外部API連携や複雑な計算処理を効率化します。

### 改修内容

#### 1. Edge Functions プロジェクト構造
```bash
supabase/
├── functions/
│   ├── calculate-buyback/
│   │   └── index.ts
│   ├── send-notification/
│   │   └── index.ts
│   ├── generate-report/
│   │   └── index.ts
│   ├── sync-zaico/
│   │   └── index.ts
│   └── _shared/
│       ├── cors.ts
│       └── supabase.ts
```

#### 2. 買取査定計算Function
```typescript
// supabase/functions/calculate-buyback/index.ts
import { serve } from 'https://deno.land/std@0.168.0/http/server.ts';
import { createClient } from 'https://esm.sh/@supabase/supabase-js@2';
import { corsHeaders } from '../_shared/cors.ts';

interface BuybackRequest {
  items: Array<{
    productId: string;
    condition: 'S' | 'A' | 'B' | 'C' | 'D';
    quantity: number;
  }>;
  customerId?: string;
}

serve(async (req) => {
  // CORS対応
  if (req.method === 'OPTIONS') {
    return new Response('ok', { headers: corsHeaders });
  }

  try {
    const { items, customerId } = await req.json() as BuybackRequest;
    
    // Supabaseクライアント作成
    const supabaseClient = createClient(
      Deno.env.get('SUPABASE_URL') ?? '',
      Deno.env.get('SUPABASE_SERVICE_ROLE_KEY') ?? '',
    );

    // 商品情報取得
    const productIds = items.map(item => item.productId);
    const { data: products } = await supabaseClient
      .from('products')
      .select('*')
      .in('id', productIds);

    // 買取価格計算
    const calculations = items.map(item => {
      const product = products?.find(p => p.id === item.productId);
      if (!product) return null;

      const conditionMultipliers = {
        'S': 0.8,
        'A': 0.7,
        'B': 0.6,
        'C': 0.4,
        'D': 0.2
      };

      const basePrice = product.selling_price;
      const multiplier = conditionMultipliers[item.condition];
      const unitPrice = Math.floor(basePrice * multiplier);
      const totalPrice = unitPrice * item.quantity;

      return {
        productId: item.productId,
        productName: product.name,
        condition: item.condition,
        quantity: item.quantity,
        unitPrice,
        totalPrice,
        originalPrice: product.selling_price
      };
    }).filter(Boolean);

    // 顧客履歴による特別価格適用
    let bonusRate = 1.0;
    if (customerId) {
      const { data: customerHistory } = await supabaseClient
        .from('transactions')
        .select('total_amount')
        .eq('user_id', customerId)
        .eq('type', 'sale');

      const totalPurchases = customerHistory?.reduce(
        (sum, tx) => sum + tx.total_amount, 
        0
      ) || 0;

      // 購入履歴に応じたボーナス
      if (totalPurchases > 100000) bonusRate = 1.15;
      else if (totalPurchases > 50000) bonusRate = 1.10;
      else if (totalPurchases > 20000) bonusRate = 1.05;
    }

    const subtotal = calculations.reduce((sum, calc) => sum + calc.totalPrice, 0);
    const bonus = Math.floor(subtotal * (bonusRate - 1));
    const total = subtotal + bonus;

    // 査定結果を保存
    const { data: estimate } = await supabaseClient
      .from('buyback_estimates')
      .insert({
        customer_id: customerId,
        items: calculations,
        subtotal,
        bonus_rate: bonusRate,
        bonus_amount: bonus,
        total_amount: total,
        expires_at: new Date(Date.now() + 7 * 24 * 60 * 60 * 1000) // 7日間有効
      })
      .select()
      .single();

    return new Response(
      JSON.stringify({
        success: true,
        estimate: {
          id: estimate.id,
          items: calculations,
          subtotal,
          bonusRate,
          bonus,
          total,
          expiresAt: estimate.expires_at,
          message: bonusRate > 1 
            ? `優良顧客ボーナス${Math.floor((bonusRate - 1) * 100)}%適用中！` 
            : null
        }
      }),
      {
        headers: { ...corsHeaders, 'Content-Type': 'application/json' },
        status: 200,
      }
    );
  } catch (error) {
    return new Response(
      JSON.stringify({ error: error.message }),
      {
        headers: { ...corsHeaders, 'Content-Type': 'application/json' },
        status: 400,
      }
    );
  }
});
```

#### 3. 通知送信Function
```typescript
// supabase/functions/send-notification/index.ts
import { serve } from 'https://deno.land/std@0.168.0/http/server.ts';
import { createClient } from 'https://esm.sh/@supabase/supabase-js@2';

interface NotificationRequest {
  type: 'email' | 'push' | 'sms';
  recipient: string;
  template: string;
  data: Record<string, any>;
}

serve(async (req) => {
  const { type, recipient, template, data } = await req.json() as NotificationRequest;

  switch (type) {
    case 'email':
      await sendEmail(recipient, template, data);
      break;
    case 'push':
      await sendPushNotification(recipient, template, data);
      break;
    case 'sms':
      await sendSMS(recipient, template, data);
      break;
  }

  return new Response(
    JSON.stringify({ success: true }),
    { headers: { 'Content-Type': 'application/json' } }
  );
});

async function sendEmail(to: string, template: string, data: any) {
  const RESEND_API_KEY = Deno.env.get('RESEND_API_KEY');
  
  const templates = {
    'order-confirmation': {
      subject: `ご注文確認 #${data.orderNumber}`,
      html: `
        <h2>ご注文ありがとうございます</h2>
        <p>注文番号: ${data.orderNumber}</p>
        <p>合計金額: ¥${data.totalAmount.toLocaleString()}</p>
      `
    },
    'buyback-estimate': {
      subject: '買取査定結果のお知らせ',
      html: `
        <h2>買取査定が完了しました</h2>
        <p>査定金額: ¥${data.amount.toLocaleString()}</p>
        <p>有効期限: ${data.expiresAt}</p>
      `
    }
  };

  const emailTemplate = templates[template];
  
  await fetch('https://api.resend.com/emails', {
    method: 'POST',
    headers: {
      'Authorization': `Bearer ${RESEND_API_KEY}`,
      'Content-Type': 'application/json',
    },
    body: JSON.stringify({
      from: 'noreply@gamestore.com',
      to,
      subject: emailTemplate.subject,
      html: emailTemplate.html
    }),
  });
}
```

#### 4. Zaico API同期Function
```typescript
// supabase/functions/sync-zaico/index.ts
serve(async (req) => {
  const supabase = createClient(
    Deno.env.get('SUPABASE_URL') ?? '',
    Deno.env.get('SUPABASE_SERVICE_ROLE_KEY') ?? '',
  );

  // Zaico APIから在庫データ取得
  const zaicoResponse = await fetch('https://web.zaico.co.jp/api/v1/inventories', {
    headers: {
      'Authorization': `Bearer ${Deno.env.get('ZAICO_API_KEY')}`,
    },
  });

  const zaicoData = await zaicoResponse.json();

  // Supabaseのデータと同期
  for (const item of zaicoData.inventories) {
    const { data: existingProduct } = await supabase
      .from('products')
      .select('id')
      .eq('zaico_id', item.id)
      .single();

    if (existingProduct) {
      // 既存商品を更新
      await supabase
        .from('inventory')
        .update({
          quantity: item.quantity,
          updated_at: new Date().toISOString(),
        })
        .eq('product_id', existingProduct.id);
    } else {
      // 新規商品を作成
      const { data: newProduct } = await supabase
        .from('products')
        .insert({
          zaico_id: item.id,
          name: item.title,
          sku: item.code,
          description: item.description,
        })
        .select()
        .single();

      await supabase
        .from('inventory')
        .insert({
          product_id: newProduct.id,
          quantity: item.quantity,
        });
    }
  }

  return new Response(
    JSON.stringify({ 
      success: true, 
      synced: zaicoData.inventories.length 
    }),
    { headers: { 'Content-Type': 'application/json' } }
  );
});
```

#### 5. クライアントからの呼び出し
```typescript
// lib/supabase/functions.ts
import { supabase } from './client';

export class EdgeFunctions {
  static async calculateBuyback(items: any[], customerId?: string) {
    const { data, error } = await supabase.functions.invoke('calculate-buyback', {
      body: { items, customerId }
    });

    if (error) throw error;
    return data;
  }

  static async sendNotification(
    type: 'email' | 'push' | 'sms',
    recipient: string,
    template: string,
    data: any
  ) {
    const { data: result, error } = await supabase.functions.invoke('send-notification', {
      body: { type, recipient, template, data }
    });

    if (error) throw error;
    return result;
  }

  static async syncWithZaico() {
    const { data, error } = await supabase.functions.invoke('sync-zaico');
    
    if (error) throw error;
    return data;
  }

  static async generateReport(reportType: string, params: any) {
    const { data, error } = await supabase.functions.invoke('generate-report', {
      body: { reportType, params }
    });

    if (error) throw error;
    return data;
  }
}
```

#### 6. Edge Functionsのデプロイスクリプト
```json
// package.json
{
  "scripts": {
    "functions:deploy": "supabase functions deploy",
    "functions:serve": "supabase functions serve",
    "functions:deploy:buyback": "supabase functions deploy calculate-buyback",
    "functions:logs": "supabase functions logs"
  }
}
```

### 影響範囲
- APIエンドポイントの削減
- サーバーサイドロジックの移行
- 外部API連携処理
- 複雑な計算処理
- 通知システム

### 所要時間
10-12時間

### 検証項目
- [ ] Edge Functionsが正常にデプロイされる
- [ ] CORSが適切に設定されている
- [ ] エラーハンドリングが適切
- [ ] パフォーマンスが要件を満たす
- [ ] 環境変数が正しく設定されている
- [ ] ログが適切に出力される

### 次のステップ
改修仕様書_54: Supabase Storage実装