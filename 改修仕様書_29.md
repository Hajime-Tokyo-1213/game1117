# 改修仕様書 29

## フェーズ2.4 - マイグレーションスクリプト作成

### 改修の目的
データベーススキーマを安全かつ段階的にデプロイするためのマイグレーションシステムを構築

### 改修内容

#### 1. マイグレーション管理システムの作成
```javascript
// scripts/migrations/migrationRunner.js
import fs from 'fs';
import path from 'path';
import { query } from '../../api/utils/database.js';

class MigrationRunner {
  async createMigrationsTable() {
    await query(`
      CREATE TABLE IF NOT EXISTS migrations (
        id SERIAL PRIMARY KEY,
        filename VARCHAR(255) NOT NULL,
        executed_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
      )
    `);
  }
  
  async runMigrations() {
    await this.createMigrationsTable();
    
    const migrationFiles = fs.readdirSync('./scripts/migrations/sql')
      .filter(file => file.endsWith('.sql'))
      .sort();
    
    for (const file of migrationFiles) {
      await this.runMigration(file);
    }
  }
  
  async runMigration(filename) {
    const { rows } = await query(
      'SELECT id FROM migrations WHERE filename = $1',
      [filename]
    );
    
    if (rows.length > 0) {
      console.log(`Migration ${filename} already executed`);
      return;
    }
    
    const sql = fs.readFileSync(`./scripts/migrations/sql/${filename}`, 'utf8');
    await query(sql);
    await query(
      'INSERT INTO migrations (filename) VALUES ($1)',
      [filename]
    );
    
    console.log(`Migration ${filename} executed successfully`);
  }
}
```

#### 2. マイグレーションファイルの作成
```sql
-- scripts/migrations/sql/001_create_users_table.sql
CREATE TABLE users (
    id SERIAL PRIMARY KEY,
    email VARCHAR(255) UNIQUE NOT NULL,
    password_hash VARCHAR(255) NOT NULL,
    role VARCHAR(50) NOT NULL DEFAULT 'customer',
    name VARCHAR(255) NOT NULL,
    phone VARCHAR(20),
    address TEXT,
    postal_code VARCHAR(10),
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

CREATE INDEX idx_users_email ON users(email);
CREATE INDEX idx_users_role ON users(role);
```

#### 3. ロールバック機能
```sql
-- scripts/migrations/rollback/001_drop_users_table.sql
DROP TABLE IF EXISTS users CASCADE;
```

#### 4. NPMスクリプトの設定
```json
{
  "scripts": {
    "db:migrate": "node scripts/migrations/migrationRunner.js",
    "db:rollback": "node scripts/migrations/rollbackRunner.js",
    "db:reset": "node scripts/migrations/resetDatabase.js"
  }
}
```

### 影響範囲
- 新規: `scripts/migrations/`ディレクトリ
- `package.json`

### 所要時間
3-4時間

### 検証項目
- マイグレーションが正常実行されること
- 重複実行時の安全性が確保されること
- ロールバック機能が正常動作すること

### 次のステップ
改修仕様書_30: 初期データ投入スクリプト作成