# 改修仕様書 33

## フェーズ2.8 - ユーザー管理API実装

### 改修の目的
ユーザー情報の管理をデータベースベースで行うAPIを実装

### 改修内容

#### 1. ユーザー一覧取得API
```javascript
// api/users/index.js
import { authMiddleware } from '../utils/middleware.js';
import { query } from '../utils/database.js';

async function handler(req, res) {
  switch (req.method) {
    case 'GET':
      return await getUsers(req, res);
    case 'POST':
      return await createUser(req, res);
    default:
      return res.status(405).json({ error: 'Method not allowed' });
  }
}

async function getUsers(req, res) {
  try {
    const { role, page = 1, limit = 50 } = req.query;
    
    let sql = 'SELECT id, email, role, name, phone, created_at FROM users';
    let params = [];
    
    if (role) {
      sql += ' WHERE role = $1';
      params.push(role);
    }
    
    sql += ` ORDER BY created_at DESC LIMIT $${params.length + 1} OFFSET $${params.length + 2}`;
    params.push(limit, (page - 1) * limit);
    
    const { rows } = await query(sql, params);
    
    // 総数取得
    const countSql = role ? 'SELECT COUNT(*) FROM users WHERE role = $1' : 'SELECT COUNT(*) FROM users';
    const countParams = role ? [role] : [];
    const { rows: countRows } = await query(countSql, countParams);
    
    res.json({
      users: rows,
      total: parseInt(countRows[0].count),
      page: parseInt(page),
      limit: parseInt(limit)
    });
    
  } catch (error) {
    console.error('Get users error:', error);
    res.status(500).json({ error: 'サーバーエラーが発生しました' });
  }
}
```

#### 2. 個別ユーザー操作API
```javascript
// api/users/[id].js
export default authMiddleware(async function handler(req, res) {
  const { id } = req.query;
  
  switch (req.method) {
    case 'GET':
      return await getUserById(req, res, id);
    case 'PUT':
      return await updateUser(req, res, id);
    case 'DELETE':
      return await deleteUser(req, res, id);
    default:
      return res.status(405).json({ error: 'Method not allowed' });
  }
});

async function getUserById(req, res, id) {
  try {
    const { rows } = await query(
      'SELECT id, email, role, name, phone, address, postal_code, created_at FROM users WHERE id = $1',
      [id]
    );
    
    if (rows.length === 0) {
      return res.status(404).json({ error: 'ユーザーが見つかりません' });
    }
    
    res.json({ user: rows[0] });
    
  } catch (error) {
    console.error('Get user error:', error);
    res.status(500).json({ error: 'サーバーエラーが発生しました' });
  }
}

async function updateUser(req, res, id) {
  try {
    const { name, phone, address, postal_code, role } = req.body;
    
    // 権限チェック（管理者または本人のみ更新可能）
    if (req.user.role !== 'admin' && req.user.userId !== parseInt(id)) {
      return res.status(403).json({ error: '権限がありません' });
    }
    
    const { rows } = await query(
      `UPDATE users 
       SET name = $2, phone = $3, address = $4, postal_code = $5, role = $6, updated_at = CURRENT_TIMESTAMP
       WHERE id = $1 RETURNING id, email, role, name, phone, address, postal_code`,
      [id, name, phone, address, postal_code, role || req.user.role]
    );
    
    if (rows.length === 0) {
      return res.status(404).json({ error: 'ユーザーが見つかりません' });
    }
    
    res.json({ user: rows[0] });
    
  } catch (error) {
    console.error('Update user error:', error);
    res.status(500).json({ error: 'サーバーエラーが発生しました' });
  }
}
```

#### 3. プロフィール専用API
```javascript
// api/users/profile.js
export default authMiddleware(async function handler(req, res) {
  switch (req.method) {
    case 'GET':
      return await getProfile(req, res);
    case 'PUT':
      return await updateProfile(req, res);
    default:
      return res.status(405).json({ error: 'Method not allowed' });
  }
});

async function getProfile(req, res) {
  try {
    const { rows } = await query(
      'SELECT id, email, role, name, phone, address, postal_code FROM users WHERE id = $1',
      [req.user.userId]
    );
    
    res.json({ profile: rows[0] });
    
  } catch (error) {
    console.error('Get profile error:', error);
    res.status(500).json({ error: 'サーバーエラーが発生しました' });
  }
}
```

### 影響範囲
- 新規: `api/users/index.js`
- 新規: `api/users/[id].js`
- 新規: `api/users/profile.js`

### 所要時間
3-4時間

### 検証項目
- CRUD操作が正常動作すること
- 権限制御が適切であること
- ページネーションが正確であること

### 次のステップ
改修仕様書_34: 在庫管理API実装