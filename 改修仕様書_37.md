# 改修仕様書 37

## フェーズ2.12 - 古物台帳API実装

### 改修の目的
法的要件に準拠した古物台帳管理をデータベースで実装

### 改修内容

#### 1. 古物台帳API実装
```javascript
// api/antiquities/index.js
import { authMiddleware } from '../utils/middleware.js';
import { query } from '../utils/database.js';

export default authMiddleware(async function handler(req, res) {
  switch (req.method) {
    case 'GET':
      return await getAntiquitiesRecords(req, res);
    case 'POST':
      return await createAntiquitiesRecord(req, res);
    default:
      return res.status(405).json({ error: 'Method not allowed' });
  }
});

async function getAntiquitiesRecords(req, res) {
  try {
    const { 
      start_date,
      end_date,
      transaction_type,
      counterpart_name,
      page = 1, 
      limit = 50 
    } = req.query;
    
    let sql = `
      SELECT *
      FROM antiquities_ledger
      WHERE 1=1
    `;
    
    const params = [];
    let paramCount = 0;
    
    if (start_date) {
      paramCount++;
      sql += ` AND transaction_date >= $${paramCount}`;
      params.push(start_date);
    }
    
    if (end_date) {
      paramCount++;
      sql += ` AND transaction_date <= $${paramCount}`;
      params.push(end_date);
    }
    
    if (transaction_type) {
      paramCount++;
      sql += ` AND transaction_type = $${paramCount}`;
      params.push(transaction_type);
    }
    
    if (counterpart_name) {
      paramCount++;
      sql += ` AND counterpart_name ILIKE $${paramCount}`;
      params.push(`%${counterpart_name}%`);
    }
    
    sql += ` ORDER BY transaction_date DESC, id DESC`;
    sql += ` LIMIT $${paramCount + 1} OFFSET $${paramCount + 2}`;
    params.push(limit, (page - 1) * limit);
    
    const { rows } = await query(sql, params);
    
    res.json({
      records: rows,
      page: parseInt(page),
      limit: parseInt(limit)
    });
    
  } catch (error) {
    console.error('Get antiquities records error:', error);
    res.status(500).json({ error: 'サーバーエラーが発生しました' });
  }
}

async function createAntiquitiesRecord(req, res) {
  try {
    // スタッフ以上のみ記録可能
    if (!['staff', 'admin'].includes(req.user.role)) {
      return res.status(403).json({ error: '権限がありません' });
    }
    
    const {
      transaction_date,
      transaction_type,
      item_name,
      item_description,
      quantity,
      unit_price,
      total_amount,
      counterpart_name,
      counterpart_address,
      counterpart_phone,
      counterpart_id_type,
      counterpart_id_number
    } = req.body;
    
    // 必須項目チェック
    const requiredFields = [
      'transaction_date', 'transaction_type', 'item_name',
      'counterpart_name', 'counterpart_address'
    ];
    
    for (const field of requiredFields) {
      if (!req.body[field]) {
        return res.status(400).json({ 
          error: `${field}は必須項目です` 
        });
      }
    }
    
    // 取引種別チェック
    if (!['purchase', 'sale'].includes(transaction_type)) {
      return res.status(400).json({ error: '無効な取引種別です' });
    }
    
    const { rows } = await query(`
      INSERT INTO antiquities_ledger (
        transaction_date, transaction_type, item_name, item_description,
        quantity, unit_price, total_amount, counterpart_name,
        counterpart_address, counterpart_phone, counterpart_id_type,
        counterpart_id_number
      ) VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9, $10, $11, $12)
      RETURNING *
    `, [
      transaction_date, transaction_type, item_name, item_description,
      quantity || 1, unit_price || 0, total_amount || 0,
      counterpart_name, counterpart_address, counterpart_phone,
      counterpart_id_type, counterpart_id_number
    ]);
    
    res.status(201).json({
      message: '古物台帳記録を作成しました',
      record: rows[0]
    });
    
  } catch (error) {
    console.error('Create antiquities record error:', error);
    res.status(500).json({ error: 'サーバーエラーが発生しました' });
  }
}
```

#### 2. 古物台帳エクスポート機能
```javascript
// api/antiquities/export.js
import { authMiddleware } from '../utils/middleware.js';
import { query } from '../utils/database.js';

export default authMiddleware(async function handler(req, res) {
  if (req.method !== 'GET') {
    return res.status(405).json({ error: 'Method not allowed' });
  }
  
  try {
    // 管理者のみエクスポート可能
    if (req.user.role !== 'admin') {
      return res.status(403).json({ error: '権限がありません' });
    }
    
    const { start_date, end_date, format = 'json' } = req.query;
    
    let sql = `
      SELECT *
      FROM antiquities_ledger
      WHERE 1=1
    `;
    
    const params = [];
    let paramCount = 0;
    
    if (start_date) {
      paramCount++;
      sql += ` AND transaction_date >= $${paramCount}`;
      params.push(start_date);
    }
    
    if (end_date) {
      paramCount++;
      sql += ` AND transaction_date <= $${paramCount}`;
      params.push(end_date);
    }
    
    sql += ` ORDER BY transaction_date ASC, id ASC`;
    
    const { rows } = await query(sql, params);
    
    if (format === 'csv') {
      // CSV形式でエクスポート
      const csvHeader = [
        'ID', '取引日', '取引種別', '品名', '品目説明', '数量',
        '単価', '金額', '相手方名', '相手方住所', '相手方電話',
        '身分証種別', '身分証番号', '登録日'
      ].join(',');
      
      const csvRows = rows.map(row => [
        row.id,
        row.transaction_date,
        row.transaction_type === 'purchase' ? '買取' : '販売',
        `"${row.item_name}"`,
        `"${row.item_description || ''}"`,
        row.quantity,
        row.unit_price,
        row.total_amount,
        `"${row.counterpart_name}"`,
        `"${row.counterpart_address}"`,
        `"${row.counterpart_phone || ''}"`,
        `"${row.counterpart_id_type || ''}"`,
        `"${row.counterpart_id_number || ''}"`,
        row.created_at
      ].join(','));
      
      const csv = [csvHeader, ...csvRows].join('\n');
      
      res.setHeader('Content-Type', 'text/csv; charset=utf-8');
      res.setHeader('Content-Disposition', `attachment; filename="antiquities_ledger_${start_date || 'all'}_${end_date || 'all'}.csv"`);
      res.send('\ufeff' + csv); // BOM for Excel compatibility
      
    } else {
      // JSON形式
      res.json({
        records: rows,
        exported_at: new Date(),
        period: { start_date, end_date }
      });
    }
    
  } catch (error) {
    console.error('Export antiquities records error:', error);
    res.status(500).json({ error: 'サーバーエラーが発生しました' });
  }
});
```

#### 3. 古物台帳バリデーション強化
```javascript
// src/utils/antiquitiesValidation.js
import { validateAndSanitize } from './validation.js';

export const validateAntiquitiesRecord = (data) => {
  const validations = {
    transaction_date: {
      value: data.transaction_date,
      isValid: !!data.transaction_date && !isNaN(new Date(data.transaction_date)),
      error: !data.transaction_date ? '取引日は必須です' : 
             isNaN(new Date(data.transaction_date)) ? '無効な日付です' : null
    },
    
    transaction_type: {
      value: data.transaction_type,
      isValid: ['purchase', 'sale'].includes(data.transaction_type),
      error: !['purchase', 'sale'].includes(data.transaction_type) ? '取引種別が無効です' : null
    },
    
    item_name: validateAndSanitize(data.item_name, 'required'),
    counterpart_name: validateAndSanitize(data.counterpart_name, 'required'),
    counterpart_address: validateAndSanitize(data.counterpart_address, 'required'),
    
    unit_price: {
      value: data.unit_price,
      isValid: !data.unit_price || (!isNaN(data.unit_price) && data.unit_price >= 0),
      error: data.unit_price && (isNaN(data.unit_price) || data.unit_price < 0) ? '単価は0以上の数値である必要があります' : null
    },
    
    quantity: {
      value: data.quantity,
      isValid: !data.quantity || (!isNaN(data.quantity) && data.quantity > 0),
      error: data.quantity && (isNaN(data.quantity) || data.quantity <= 0) ? '数量は正の数値である必要があります' : null
    }
  };
  
  const hasErrors = Object.values(validations).some(v => !v.isValid);
  const errors = Object.fromEntries(
    Object.entries(validations)
      .filter(([_, v]) => v.error)
      .map(([k, v]) => [k, v.error])
  );
  
  return { isValid: !hasErrors, errors, sanitized: validations };
};
```

### 影響範囲
- `api/antiquities/index.js`（既存の拡張）
- 新規: `api/antiquities/export.js`
- 新規: `src/utils/antiquitiesValidation.js`

### 所要時間
3-4時間

### 検証項目
- 古物台帳の法的要件準拠
- データエクスポート機能が正常動作すること
- バリデーションが適切であること

### 次のステップ
改修仕様書_38: ダッシュボードAPI実装